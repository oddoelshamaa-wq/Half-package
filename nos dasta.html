                        <!DOCTYPE html>
                    <html lang="ar" dir="rtl">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>Half package Ø§Ù…ÙˆÙ‚Ø¹ ÙƒØ§Ù…Ù„</title>
                            
                            <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© -->
                            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&display=swap" rel="stylesheet">
                            <!-- 1. Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ù…Ù† Ø±ÙˆØ§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ´ØºÙŠÙ„ -->
                            <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
                            <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

                            <script>
                            // 2. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                            const firebaseConfig = {
                                apiKey: "AIzaSyAW8noByzSW8bIvNtNXfEGppXiorJAogfs",
                                authDomain: "half-package.firebaseapp.com",
                                projectId: "half-package",
                                // Ø£Ø¶Ù Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
                                databaseURL: "https://half-package-default-rtdb.firebaseio.com",
                                storageBucket: "half-package.firebasestorage.app",
                                messagingSenderId: "78287254900",
                                appId: "1:78287254900:web:9b2d46eb5d332d6b5d2821",
                                measurementId: "G-51W2CFF6NN"
                            };

                            // 3. Ø§Ù„ØªØ´ØºÙŠÙ„
                            firebase.initializeApp(firebaseConfig);
                            const dbHub = firebase.database(); // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø°ÙŠ ÙŠØ³ØªØ®Ø¯Ù…Ù‡ ÙƒÙˆØ¯Ùƒ

                            // 4. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ³Ù…Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„)
                            window.onload = () => {
                                // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø§Ù„Ø°ÙŠ ÙŠØ³ØªØ¯Ø¹ÙŠ initCoreDataListeners()
                                initCoreDataListeners();
                            };
                            </script>

                            <script>
                            // Ù…Ù†Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ (Right Click)
                            document.addEventListener('contextmenu', event => event.preventDefault());

                            // Ù…Ù†Ø¹ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø´Ù‡ÙˆØ±Ø© Ù„ÙØªØ­ Inspect Element
                            document.onkeydown = function(e) {
                                if (e.keyCode == 123) { // F12
                                    return false;
                                }
                                if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { // Ctrl+Shift+I
                                    return false;
                                }
                                if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { // Ctrl+Shift+C
                                    return false;
                                }
                                if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { // Ctrl+Shift+J
                                    return false;
                                }
                                if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { // Ctrl+U (Ø±Ø¤ÙŠØ© Ø§Ù„Ø³ÙˆØ±Ø³)
                                    return false;
                                }
                            }
                            </script>

                            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                            <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
                            
                            <style>
                                /* 
                                ========================================================================
                                --- CSS MASTER ARCHITECTURE: VIP HOVER EDITION --- 
                                ========================================================================
                                */
                    :root {
                        --primary-bg-core: #373937;
                        --glass-surface: rgba(55, 57, 55, 0.96);
                        --gold-master: #e64026;
                        --gold-bright: #ff6b6b;
                        --accent-navy: #4ebf57;
                        --success-glow: #4ebf57;
                        --danger-pulse: #e64026;
                        --text-pure: #d8dcdd;
                        --text-muted-core: #a0a0a0;
                        --border-glow-line: rgba(230, 64, 38, 0.28);
                        --radius-massive: 8px;
                        --shadow-depth: 0 30px 60px rgba(0,0,0,0.85), inset 0 1px 2px rgba(255,255,255,0.06);
                        --font-stack: 'Cairo', sans-serif;
                        --transition-speed: 0.2s;
                        --sidebar-width: 200px;
                    }

                                /* Animations */
                                @keyframes slideRightFade { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
                                @keyframes slideUpFade { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
                                @keyframes rotateBrand { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
                                @keyframes slideInRight { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
                                @keyframes pulseLive { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

                                ::-webkit-scrollbar { width: 10px; }
                                ::-webkit-scrollbar-track { background: var(--primary-bg-core); }
                                ::-webkit-scrollbar-thumb { background: linear-gradient(var(--gold-master), #b91c1c); border-radius: 12px; border: 3px solid var(--primary-bg-core); }

                                * { box-sizing: border-box; outline: none; margin: 0; padding: 0; transition: var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1); }

                    body {
                        font-family: var(--font-stack);
                        background: var(--primary-bg-core);
                        color: var(--text-pure);
                        min-height: 100vh;
                        overflow-x: hidden;
                        font-size: 13px;
                        background-image: radial-gradient(circle at 5% 5%, rgba(230, 64, 38, 0.08) 0%, transparent 45%), radial-gradient(circle at 95% 95%, rgba(78, 191, 87, 0.08) 0%, transparent 50%);
                        background-attachment: fixed;
                    }

                                /* Layout */
                                .system-side-nav {
                                    position: fixed; top: 20px; right: 20px; bottom: 20px; width: var(--sidebar-width);
                                    background: var(--glass-surface); backdrop-filter: blur(55px);
                                    border: 1px solid var(--border-glow-line); border-radius: var(--radius-massive);
                                    box-shadow: var(--shadow-depth); z-index: 1000;
                                    display: flex; flex-direction: column; padding: 20px 15px; overflow-y: auto;
                                    animation: slideRightFade 0.8s ease-out;
                                }

                                .vip-master-container {
                                    margin-right: calc(var(--sidebar-width) + 30px); margin-left: 20px;
                                    padding-top: 20px; padding-bottom: 100px; max-width: 100%;
                                    animation: slideUpFade 0.7s ease-out;
                                }

                                .hamburger-btn { display: none; position: fixed; top: 20px; right: 20px; z-index: 1100; background: var(--gold-master); color: #000; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem; cursor: pointer; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4); }

                                /* Mobile Responsive */
                                @media (max-width: 768px) {
                                    body { font-size: 12px; }
                                    .vip-master-container { margin-right: 0 !important; margin-left: 0 !important; padding: 15px !important; padding-top: 80px !important; }
                                    .system-side-nav { width: 280px !important; right: -300px !important; top: 0 !important; bottom: 0 !important; height: 100vh !important; border-radius: 0 !important; z-index: 3000 !important; }
                                    .system-side-nav.open { right: 0 !important; }
                                    .hamburger-btn { display: flex !important; }
                                    .login-card-massive { width: 95% !important; padding: 40px 20px !important; }
                                    .floating-action-master { width: 60px !important; height: 60px !important; font-size: 1.8rem !important; bottom: 20px !important; left: 20px !important; }
                                    .admin-layout-flex { grid-template-columns: 1fr !important; }
                                    h1 { font-size: 2rem !important; }
                                }

                                /* Sidebar Elements */
                                .identity-matrix { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 50px; padding-bottom: 30px; border-bottom: 2px solid rgba(255,255,255,0.05); }
                                .identity-orb-vip { width: 70px; height: 70px; background: linear-gradient(135deg, var(--gold-master), #b45309); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 950; color: #000; font-size: 1.8rem; border: 4px solid rgba(255,255,255,0.2); box-shadow: 0 10px 40px rgba(245, 158, 11, 0.4); cursor: pointer; margin-bottom: 10px; }
                                .identity-orb-vip:hover { animation: rotateBrand 2s infinite linear; }
                                .nav-hub-menu { display: flex; flex-direction: column; gap: 15px; flex: 1; }
                                .nav-link-vip { background: rgba(255,255,255,0.03); border: 1px solid transparent; color: var(--text-muted-core); padding: 15px 20px; border-radius: 18px; cursor: pointer; font-family: var(--font-stack); font-weight: 800; font-size: 1rem; display: flex; align-items: center; gap: 18px; width: 100%; }
                                .nav-link-vip:hover, .nav-link-vip.active { background: rgba(245, 158, 11, 0.15); color: var(--gold-master); border-color: var(--border-glow-line); transform: translateX(-8px); }
                                .nav-link-vip.active { background: var(--gold-master); color: #000; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4); }
                                .logout-btn-sidebar { margin-top: auto; background: rgba(239, 68, 68, 0.1) !important; color: var(--danger-pulse) !important; border: 1px solid rgba(239, 68, 68, 0.3) !important; justify-content: center; }

                                /* Cards & Inputs */
                                .massive-glass-card { background: var(--glass-surface); backdrop-filter: blur(55px); border: 1px solid var(--border-glow-line); border-radius: var(--radius-massive); box-shadow: var(--shadow-depth); position: relative; overflow: hidden; }
                                .floating-action-master { position: fixed; bottom: 50px; left: 50px; width: 100px; height: 100px; border-radius: 50%; background: var(--gold-master); color: #000; font-size: 3.5rem; border: none; cursor: pointer; z-index: 2000; box-shadow: 0 40px 90px rgba(245, 158, 11, 0.8); display: flex; align-items: center; justify-content: center; }
                                .floating-action-master:hover { transform: scale(1.1) rotate(90deg); }
                                
                                .sidebar-complaint-master { position: fixed; top: 0; left: -700px; width: 600px; height: 100%; background: #0b0e14; border-right: 12px solid var(--gold-master); z-index: 2600; padding: 70px; transition: 1s cubic-bezier(0.7, 0, 0.1, 1); box-shadow: 60px 0 200px rgba(0,0,0,1); overflow-y: auto; }
                                .sidebar-complaint-master.open { left: 0; }
                                .dimmer-overlay-master { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); z-index: 2599; display: none; }

                                /*
                    ============================================================
                    --- VIP COMPACT MODE (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¶Ø®Ù…) ---
                    ============================================================
                    */

                    :root {
                        /* ØªØµØºÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶ */
                        --sidebar-width: 240px;
                        --radius-massive: 12px;
                        --transition-speed: 0.2s;
                    }

                    body {
                        /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…ÙˆÙ‚Ø¹ */
                        font-size: 13px;
                    }

                    /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (ØªØµØºÙŠØ± ÙƒÙ„ÙŠ) --- */
                    .system-side-nav {
                        width: var(--sidebar-width);
                        padding: 15px 10px;
                        top: 15px; right: 15px; bottom: 15px;
                    }

                    .identity-orb-vip {
                        width: 60px; height: 60px; /* ØªØµØºÙŠØ± Ø§Ù„Ø£ÙØ§ØªØ§Ø± Ù…Ù† 110px */
                        font-size: 1.5rem;
                        border-width: 3px;
                        margin-bottom: 10px;
                    }

                    .identity-labels h2 { font-size: 1rem; }
                    .identity-labels span { font-size: 0.75rem; }

                    .nav-link-vip {
                        padding: 10px 12px;
                        font-size: 0.85rem;
                        gap: 10px;
                        border-radius: 10px;
                        margin-bottom: 5px;
                    }

                    /* --- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
                    .vip-master-container {
                        margin-right: calc(var(--sidebar-width) + 30px);
                        margin-left: 15px;
                        padding-top: 15px;
                    }

                    h1 { font-size: 1.6rem !important; margin-bottom: 15px !important; }

                    /* --- Ø§Ù„Ø¨Ø« Ø§Ù„Ø­ÙŠ (ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ø´Ø¨ÙƒØ© ÙƒØ±ÙˆØª ØµØºÙŠØ±Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶Ù‡Ø§) --- */
                    #render-live-feed-matrix {
                        display: grid;
                        /* ÙŠØ¸Ù‡Ø± 3 Ø£Ùˆ 4 Ø¨Ù„Ø§ØºØ§Øª ÙÙŠ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ÙˆØ§Ø­Ø¯ */
                        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                        gap: 12px;
                    }

                    .ticket-visual-unit {
                        padding: 15px;
                        border-radius: var(--radius-massive);
                        border-right: 6px solid var(--gold-master);
                        margin-bottom: 15px;
                        background: #0d1117;
                        height: 110px; /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙƒØ§Ø±Øª ÙˆÙ‡Ùˆ Ù…Ù‚ÙÙˆÙ„ */
                        overflow: hidden;
                        transition: all 0.3s ease;
                        cursor: pointer;
                        position: relative;
                        border: 1px solid rgba(255,255,255,0.05);
                    }

                    /* Ø­Ø§Ù„Ø© Ø§Ù„Ù€ Hover Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· (is-fixed) */
                    .ticket-visual-unit:hover,
                    .ticket-visual-unit.is-fixed {
                        height: auto;
                        min-height: 110px;
                        background: #161b22;
                        border-color: var(--gold-bright);
                        z-index: 100;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                        transform: translateY(-2px);
                    }

                    /* ØªØµÙ…ÙŠÙ… Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ù„ÙŠÙƒÙˆÙ† ÙˆØ§Ø¶Ø­ Ø¬Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ */
                    .order-number-badge {
                        font-size: 2.2rem !important; /* Ø§Ù„Ø±Ù‚Ù… ÙƒØ¨ÙŠØ± ÙˆÙˆØ§Ø¶Ø­ */
                        font-weight: 900;
                        color: #ffffff;
                        display: block;
                        margin: 5px 0;
                        line-height: 1;
                    }

                    .ticket-hidden-details {
                        opacity: 0;
                        display: none;
                    }

                    .ticket-visual-unit:hover .ticket-hidden-details,
                    .ticket-visual-unit.is-fixed .ticket-hidden-details {
                        opacity: 1;
                        display: block;
                        margin-top: 15px;
                        padding-top: 15px;
                        border-top: 1px solid rgba(255,255,255,0.1);
                    }

                    /* ØªØµØºÙŠØ± Ø¹Ø§Ù… Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø´Ø§Ù† Ù…ÙŠØ¨Ù‚Ø§Ø´ Ø¶Ø®Ù… */
                    .vip-master-container { padding: 10px; margin-right: calc(var(--sidebar-width) + 20px); }
                    h1 { font-size: 1.4rem !important; }
                    .btn-vip-execute-master { padding: 10px; font-size: 0.9rem; }

                                /* ================================================== */

                                .badge-status-glow { padding: 10px 20px; border-radius: 12px; font-size: 0.95rem; font-weight: 950; display: inline-block; margin-bottom: 20px; letter-spacing: 1px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

                                .daily-matrix-display { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 40px; }
                                .branch-data-card { padding: 50px; text-align: center; border-bottom: 10px solid var(--gold-master); background: rgba(255,255,255,0.04); border-radius: var(--radius-massive); }
                                .massive-daily-input { font-size: 5rem; font-weight: 950; color: var(--gold-master); width: 100%; text-align: center; background: transparent; border: none; border-bottom: 6px solid var(--border-glow-line); margin-top: 30px; }
                                
                                input, select, textarea { width: 100%; padding: 20px; border-radius: 18px; background: #010409; border: 2px solid var(--border-glow-line); color: white; margin-bottom: 25px; font-family: var(--font-stack); font-size: 1.1rem; }
                                input:focus, select:focus { border-color: var(--gold-master); box-shadow: 0 0 25px rgba(245, 158, 11, 0.25); }
                                .btn-vip-execute-master { background: var(--gold-master); color: #000; border: none; padding: 20px; border-radius: 20px; font-weight: 950; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 15px; font-size: 1.2rem; box-shadow: 0 20px 50px rgba(245, 158, 11, 0.4); }
                                .btn-vip-execute-master:hover { filter: brightness(1.2); transform: translateY(-5px); }

                                .stat-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 80px; }
                                .analytics-pill-card { padding: 50px; text-align: center; border-radius: 30px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-glow-line); }
                                .analytics-pill-card h2 { font-size: 3.5rem; font-weight: 950; color: var(--gold-master); }
                                .analytics-dual-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 40px; margin-top: 50px; }
                                .chart-viewport-massive { padding: 60px; background: rgba(0,0,0,0.45); border-radius: 40px; border: 2px solid var(--border-glow-line); }

                                .admin-layout-flex { display: grid; grid-template-columns: 1fr; gap: 60px; }
                                @media(min-width: 1600px) { .admin-layout-flex { grid-template-columns: 1.5fr 1fr; } }
                                .scrollable-admin-list { max-height: 400px; overflow-y: auto; border: 2px solid var(--border-glow-line); border-radius: 20px; padding: 25px; background: rgba(0,0,0,0.3); }
                                .admin-row-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
                                
                                #system-toast-container { position: fixed; bottom: 40px; left: 40px; z-index: 6000; }
                                .toast-msg-vip { background: var(--gold-master); color: #000; padding: 20px 40px; border-radius: 15px; font-weight: 950; box-shadow: 0 20px 45px rgba(0,0,0,0.7); margin-top: 15px; display: flex; align-items: center; gap: 15px; animation: slideInRight 0.6s; }
                                
                                #auth-portal-mask { height: 100vh; display: flex; align-items: center; justify-content: center; background: #000; z-index: 9999; position: fixed; inset: 0; }
                                .login-card-massive { width: 650px; padding: 100px 80px; text-align: center; border: 6px solid var(--gold-master); }
                                .hidden { display: none !important; }

                                /* --- Ø±Ø§Ø¯Ø§Ø± VIP Ø§Ù„Ù…Ø¯Ù…Ø¬ ÙˆØ§Ù„Ø£Ù†ÙŠÙ‚ --- */
                                .presence-grid {
                                    display: flex;
                                    flex-wrap: wrap;
                                    gap: 15px; /* Ù…Ø³Ø§ÙØ© ØµØºÙŠØ±Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ */
                                    justify-content: flex-start; /* Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
                                    padding: 10px;
                                }

                                .presence-user-orb {
                                    width: 75px; /* Ø¹Ø±Ø¶ Ù…Ø¯Ù…Ø¬ Ø¬Ø¯Ø§Ù‹ */
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                }

                                .presence-user-orb:hover { transform: scale(1.1); }

                                /* Ø§Ù„Ø£ÙØ§ØªØ§Ø± Ø§Ù„ØµØºÙŠØ± ÙˆØ§Ù„Ø£Ù†ÙŠÙ‚ */
                                .avatar-ring {
                                    width: 50px; /* Ø­Ø¬Ù… ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ */
                                    height: 50px;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    background: #161b22;
                                    border: 2px solid #30363d;
                                    font-size: 1.2rem;
                                    font-weight: bold;
                                    color: #8b949e;
                                    position: relative;
                                }

                                /* ØªÙˆÙ‡Ø¬ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† */
                                .orb-online .avatar-ring {
                                    border-color: #238636; /* Ø£Ø®Ø¶Ø± Ù‡Ø§Ø¯Ø¦ */
                                    box-shadow: 0 0 10px rgba(35, 134, 54, 0.4);
                                    color: #39d353;
                                }

                                /* Ù†Ù‚Ø·Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© */
                                .status-indicator {
                                    position: absolute;
                                    bottom: 2px;
                                    right: 2px;
                                    width: 12px;
                                    height: 12px;
                                    border-radius: 50%;
                                    border: 2px solid #0d1117;
                                    background: #484f58;
                                }

                                .orb-online .status-indicator { background: #39d353; }

                                .user-name-label {
                                    margin-top: 5px;
                                    font-size: 0.85rem;
                                    color: #f0f6fc;
                                    text-align: center;
                                    width: 100%;
                                    overflow: hidden;
                                    text-overflow: ellipsis;
                                    white-space: nowrap;
                                }

                                .user-rank-mini { display: none; } /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±ØªØ¨Ø© Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø© */

                                /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† (Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹) */
                                .orb-offline .avatar-ring {
                                    border: 2px solid #30363d;
                                    filter: grayscale(1); /* Ø¬Ø¹Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù‡ØªØ© Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
                                }

                                .orb-offline .status-indicator {
                                    background: #484f58; /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ù„Ù„Ø­Ø§Ù„Ø© */
                                    box-shadow: none;
                                }

                                .orb-online .status-indicator {
                                    background: #39d353;
                                    box-shadow: 0 0 10px #39d353;
                                    animation: pulseLive 2s infinite;
                                }

                                @keyframes pulseLive {
                                    0% { transform: scale(1); opacity: 1; }
                                    50% { transform: scale(1.2); opacity: 0.7; }
                                    100% { transform: scale(1); opacity: 1; }
                                }

                        /* ØªÙ†Ø³ÙŠÙ‚ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· - 4 Ø£Ø¹Ù…Ø¯Ø© */
                        .log-table-row {
                            display: grid;
                            /* Ø§Ù„Ù…ÙˆØ¸Ù (ÙŠÙ…ÙŠÙ†) | Ø§Ù„Ø­Ø¯Ø« | Ø§Ù„ØªÙˆÙ‚ÙŠØª | Ø§Ù„ÙØ±Ø¹ (ÙŠØ³Ø§Ø±) */
                            grid-template-columns: 1.5fr 1.5fr 1.2fr 1fr;
                            padding: 12px 20px;
                            border-bottom: 1px solid rgba(255,255,255,0.05);
                            font-size: 0.9rem;
                            align-items: center;
                            direction: rtl; /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ù† */
                        }

                        .log-header {
                            font-weight: 800;
                            color: var(--gold-master);
                            background: rgba(255, 255, 255, 0.02);
                            border-bottom: 2px solid var(--gold-master);
                            position: sticky;
                            top: 0;
                            z-index: 5;
                        }

                        .scrollable-admin-list {
                            max-height: 400px;
                            overflow-y: auto;
                            background: rgba(0,0,0,0.2);
                            border-radius: 0 0 10px 10px;
                        }

                                .log-action-pill {
                                    padding: 5px 12px;
                                    border-radius: 8px;
                                    font-size: 0.85rem;
                                    font-weight: 800;
                                    display: inline-block;
                                }

                                .radar-header-container {
                                    display: flex;
                                    align-items: center;
                                    justify-content: space-between;
                                    margin-bottom: 30px;
                                }

                                .scan-line {
                                    height: 2px;
                                    background: linear-gradient(90deg, transparent, var(--success-glow), transparent);
                                    width: 100%;
                                    position: relative;
                                    overflow: hidden;
                                    margin-bottom: 20px;
                                }
                                .scan-line::after {
                                    content: '';
                                    position: absolute;
                                    left: -100%;
                                    width: 100%;
                                    height: 100%;
                                    background: linear-gradient(90deg, transparent, #fff, transparent);
                                    animation: scanning 3s linear infinite;
                                }
                                @keyframes scanning {
                                    0% { left: -100%; }
                                    100% { left: 100%; }
                                }

                                /*
                    ============================================================
                    --- VIP COMPACT MODE (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¶Ø®Ù…) ---
                    ============================================================
                    */

                    :root {
                        /* ØªØµØºÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶ */
                        --sidebar-width: 240px;
                        --radius-massive: 12px;
                        --transition-speed: 0.2s;
                    }

                    body {
                        /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…ÙˆÙ‚Ø¹ */
                        font-size: 13px;
                    }

                    /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (ØªØµØºÙŠØ± ÙƒÙ„ÙŠ) --- */
                    .system-side-nav {
                        width: var(--sidebar-width);
                        padding: 15px 10px;
                        top: 15px; right: 15px; bottom: 15px;
                    }

                    .identity-orb-vip {
                        width: 60px; height: 60px; /* ØªØµØºÙŠØ± Ø§Ù„Ø£ÙØ§ØªØ§Ø± Ù…Ù† 110px */
                        font-size: 1.5rem;
                        border-width: 3px;
                        margin-bottom: 10px;
                    }

                    .identity-labels h2 { font-size: 1rem; }
                    .identity-labels span { font-size: 0.75rem; }

                    .nav-link-vip {
                        padding: 10px 12px;
                        font-size: 0.85rem;
                        gap: 10px;
                        border-radius: 10px;
                        margin-bottom: 5px;
                    }

                    /* --- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
                    .vip-master-container {
                        margin-right: calc(var(--sidebar-width) + 30px);
                        margin-left: 15px;
                        padding-top: 15px;
                    }

                    h1 { font-size: 1.6rem !important; margin-bottom: 15px !important; }

                    /* --- Ø§Ù„Ø¨Ø« Ø§Ù„Ø­ÙŠ (ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ø´Ø¨ÙƒØ© ÙƒØ±ÙˆØª ØµØºÙŠØ±Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶Ù‡Ø§) --- */
                    #render-live-feed-matrix {
                        display: grid;
                        /* ÙŠØ¸Ù‡Ø± 3 Ø£Ùˆ 4 Ø¨Ù„Ø§ØºØ§Øª ÙÙŠ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ÙˆØ§Ø­Ø¯ */
                        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                        gap: 12px;
                    }

                    .ticket-visual-unit {
                        padding: 12px 15px;
                        height: 100px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¬Ø¯Ø§Ù‹ */
                        margin-bottom: 0;
                        border-right-width: 6px;
                        background: #0d1117;
                        border-radius: 10px;
                        transition: 0.3s;
                    }

                    /* ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙƒØ§Ø±Øª Ø¹Ù†Ø¯ Ø§Ù„ÙˆÙ‚ÙˆÙ Ø¹Ù„ÙŠÙ‡ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ */
                    .ticket-visual-unit:hover {
                        height: auto;
                        min-height: 100px;
                        z-index: 100;
                    }

                    /* ØªØµØºÙŠØ± Ø§Ù„Ù†ØµÙˆØµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ù„Ø§Øº */
                    .ticket-visual-unit b { font-size: 1rem !important; } /* Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ */
                    .ticket-visual-unit div { font-size: 0.75rem; } /* Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª */

                    /* ØªØµØºÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø§Ù„Ø¶Ø®Ù… */
                    .ticket-visual-unit div[style*="font-size: 3rem"],
                    .ticket-visual-unit div[style*="font-size: 5rem"] {
                        font-size: 1.4rem !important;
                        font-weight: 900;
                        margin: 5px 0 !important;
                    }

                    /* --- ØªØµØºÙŠØ± Ø§Ù„Ø®Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± --- */
                    input, select, textarea {
                        padding: 8px 12px;
                        font-size: 0.85rem;
                        margin-bottom: 10px;
                        border-radius: 8px;
                    }

                    .btn-vip-execute-master {
                        padding: 10px;
                        font-size: 0.95rem;
                        border-radius: 10px;
                    }

                    /* ØªØµØºÙŠØ± Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… */
                    .floating-action-master {
                        width: 55px; height: 55px;
                        font-size: 1.5rem;
                        bottom: 20px; left: 20px;
                    }

                    /* --- ØªØµØºÙŠØ± ÙƒØ±ÙˆØª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ÙŠÙˆÙ…ÙŠØ© --- */
                    .analytics-pill-card {
                        padding: 20px;
                    }
                    .analytics-pill-card h2 {
                        font-size: 1.8rem;
                    }
                    .branch-data-card {
                        padding: 20px;
                    }
                    .massive-daily-input {
                        font-size: 2.5rem; /* ØªØµØºÙŠØ± Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¶Ø®Ù… */
                    }
                                /* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ù†Ø°Ø§Ø± */
                                .alarm-screen {
                                    position: fixed;
                                    top: 0; left: 0; width: 100%; height: 100%;
                                    background-color: rgba(220, 38, 38, 0.85); /* Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ø´ÙØ§Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
                                    z-index: 10000; /* ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡ */
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    backdrop-filter: blur(10px);
                                    animation: flashRed 1s infinite; /* ÙˆÙ…ÙŠØ¶ Ù…Ø³ØªÙ…Ø± */
                                }

                                /* Ø­Ø±ÙƒØ© Ø§Ù„ÙˆÙ…ÙŠØ¶ */
                                @keyframes flashRed {
                                    0% { background-color: rgba(220, 38, 38, 0.85); box-shadow: inset 0 0 0 0 red; }
                                    50% { background-color: rgba(185, 28, 28, 0.95); box-shadow: inset 0 0 100px 50px #ff0000; }
                                    100% { background-color: rgba(220, 38, 38, 0.85); box-shadow: inset 0 0 0 0 red; }
                                }

                                .alarm-content {
                                    text-align: center;
                                    color: white;
                                    background: #000;
                                    padding: 40px;
                                    border-radius: 20px;
                                    border: 4px solid #fca5a5;
                                    box-shadow: 0 0 50px rgba(0,0,0,0.8);
                                }

                                .btn-stop-alarm {
                                    background: #fff;
                                    color: #dc2626;
                                    border: none;
                                    padding: 15px 40px;
                                    font-size: 1.5rem;
                                    font-weight: 900;
                                    border-radius: 50px;
                                    cursor: pointer;
                                    margin-top: 20px;
                                    transition: 0.2s;
                                }

                                .btn-stop-alarm:hover {
                                    transform: scale(1.1);
                                    box-shadow: 0 0 20px #fff;
                                }

                                /* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¹Ù„ÙˆÙŠ */
                                .license-banner {
                                    position: fixed;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 40px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: bold;
                                    font-size: 14px;
                                    z-index: 9998; /* ØªØ­Øª Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© */
                                    direction: rtl;
                                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                                }

                                .banner-warning { background-color: #fbbf24; color: #000; } /* Ø£ØµÙØ± */
                                .banner-grace { background-color: #ef4444; color: #fff; }    /* Ø£Ø­Ù…Ø± */

                                /* Ø¯ÙØ¹ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø£Ø³ÙÙ„ Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø´Ø±ÙŠØ· */
                                .push-content { margin-top: 40px !important; }

                                /* Ø¥Ø®ÙØ§Ø¡ Ø¢Ø®Ø± ØµÙ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ùˆ ÙƒØ§Ù† Ù‡Ùˆ ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù… */
                            </style>
                        </head>
                        <body>

                            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ØµÙˆØ±Ø© ØªÙ…Ø§Ù…Ø§Ù‹ -->
                            <div id="license-lock-screen" style="display:none; position:fixed; inset:0; background:#0b0e14; z-index:100000; flex-direction:column; align-items:center; justify-content:center; font-family:'Cairo', sans-serif; direction:rtl;">

                                <!-- Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
                                <div style="width: 450px; padding: 50px 40px; background: #161b22; border: 2px solid #ef4444; border-radius: 40px; text-align: center; box-shadow: 0 0 60px rgba(239, 68, 68, 0.15);">

                                    <h1 style="color: white; font-size: 42px; font-weight: 900; margin-bottom: 15px; letter-spacing: -1px;">ØªÙˆÙ‚Ù Ø§Ù„Ù†Ø¸Ø§Ù…!</h1>

                                    <p id="lock-reason-text" style="color: #8b949e; font-size: 18px; margin-bottom: 35px; font-weight: 600;">Ø§Ù†ØªÙ‡Øª ÙØªØ±Ø© Ø§Ù„Ø³Ù…Ø§Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.</p>

                                    <!-- ÙƒØ§Ø±Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ (Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø°Ù‡Ø¨ÙŠ) -->
                                    <div style="background: #1c2128; padding: 30px; border-radius: 20px; border-right: 6px solid #f59e0b; text-align: right; position: relative; overflow: hidden;">
                                        <div style="margin-bottom: 12px; display: flex; align-items: center; justify-content: flex-start; gap: 10px;">
                                            <span style="color: white; font-weight: 800; font-size: 20px;">Ù„Ù„ØªÙˆØ§ØµÙ„:</span>
                                            <span id="p-phone" style="color: white; font-size: 20px; font-weight: 700;">0100000000</span>
                                        </div>

                                        <div style="margin-bottom: 12px; display: flex; align-items: center; justify-content: flex-start; gap: 10px;">
                                            <span style="color: white; font-weight: 800; font-size: 20px;">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ:</span>
                                            <span id="p-acc" style="color: white; font-size: 20px; font-weight: 700;">---</span>
                                        </div>

                                        <div style="display: flex; align-items: center; justify-content: flex-start; gap: 10px;">
                                            <span style="color: white; font-weight: 800; font-size: 20px;">Ø§Ù„Ø§Ø³Ù…:</span>
                                            <span id="p-name" style="color: white; font-size: 20px; font-weight: 700;">---</span>
                                        </div>


                                    </div>

                                </div>
                            </div>

                            <div id="system-toast-container"></div>
                            <div id="master-dimmer" class="dimmer-overlay-master" onclick="closeAllMenus()"></div>

                            <!-- Ù…Ù„Ù Ø§Ù„ØµÙˆØª Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
                            <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

                            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ -->
                            <div id="red-alarm-overlay" class="alarm-screen hidden">
                                <div class="alarm-content">
                                    <i class="fas fa-bell fa-shake" style="font-size: 5rem; margin-bottom: 20px;"></i>
                                    <h1>ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…! ğŸš¨</h1>
                                    <p>ÙŠÙˆØ¬Ø¯ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯ ÙŠØ®Øµ ÙØ±Ø¹Ùƒ</p>
                                    <button class="btn-stop-alarm" onclick="stopAlarmAndShowTicket()">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ù„Ø§Øº ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª</button>
                                </div>
                            </div>

                            <!-- Ø´Ø§Ø´Ø© Ù‚ÙÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„Ø© -->
                            <div id="system-lock-overlay" style="display:none; position:fixed; inset:0; background:#0f172a; z-index:99999; flex-direction:column; align-items:center; justify-content:center; font-family:'Cairo', sans-serif; direction:rtl; color:white; padding:20px;">
                                <div style="background:#1e293b; padding:40px; border-radius:20px; width:100%; max-width:500px; border:1px solid #334155; text-align:center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
                                    <h2 style="color:white; margin-bottom:30px; font-weight:900;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>

                                    <div id="lock-reason-box" style="background:#0d1117; padding:25px; border-radius:15px; border-right:5px solid #fbbf24; margin-bottom:25px;">
                                        <span style="font-size:14px; color:#94a3b8; display:block; margin-bottom:10px;">Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span>
                                        <div id="lock-title" style="font-size:2rem; font-weight:900; color:#ef4444; margin-bottom:10px;">LOCKED</div>
                                        <p id="lock-msg" style="font-size:16px; color:#fca5a5; margin:0;"></p>
                                    </div>

                                    <div style="text-align:right; margin-bottom:20px;">
                                        <label style="color:#94a3b8; font-size:13px; display:block; margin-bottom:15px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ù„Ù„ØªÙˆØ§ØµÙ„:</label>
                                        <div style="background:#0d1117; padding:15px; border-radius:10px; margin-bottom:10px; border:1px solid #334155;">
                                            <span style="color:#fbbf24; font-size:12px;">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:</span>
                                            <div id="pay-phone" style="font-weight:bold; font-size:1.1rem; margin-top:5px;">--</div>
                                        </div>
                                        <div style="background:#0d1117; padding:15px; border-radius:10px; margin-bottom:10px; border:1px solid #334155;">
                                            <span style="color:#fbbf24; font-size:12px;">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:</span>
                                            <div id="pay-acc" style="font-weight:bold; font-size:1.1rem; margin-top:5px;">--</div>
                                        </div>
                                        <div style="background:#0d1117; padding:15px; border-radius:10px; border:1px solid #334155;">
                                            <span style="color:#fbbf24; font-size:12px;">Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨:</span>
                                            <div id="pay-name" style="font-weight:bold; font-size:1.1rem; margin-top:5px;">--</div>
                                        </div>
                                    </div>
                                    <p style="font-size:12px; color:#64748b;">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù….</p>
                                </div>
                            </div>

                            <!-- Authentication Portal -->
                            <div id="auth-portal-mask">
                                <div class="massive-glass-card login-card-massive">
                                    <div class="identity-orb-vip" style="margin: 0 auto; cursor: default;">CMS</div>
                                    <h1 style="color:var(--gold-master); font-weight:950; margin-bottom:20px;">Half package cms</h1>
                                    <p style="color:var(--text-muted-core); font-weight:900;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ Ø§Ù„ÙØ§Ø¦Ù‚ V47.0</p>
                                    <div style="margin-top: 40px;">
                                        <label>ÙƒÙˆØ¯ Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© (UID)</label>
                                        <input type="text" id="auth-uid-master" placeholder="UID">
                                        <label>Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ù…Ø´ÙØ± (PWD)</label>
                                        <input type="password" id="auth-pwd-master" placeholder="PWD">
                                        <button class="btn-vip-execute-master" onclick="runSecurityAuthSequence()">ÙˆÙ„ÙˆØ¬ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© <i class="fas fa-shield-halved"></i></button>
                                    </div>
                                </div>
                            </div>

                            <!-- Main Interface -->
                            <div id="main-system-viewport" class="hidden">
                                
                                <nav class="system-side-nav" id="system-side-nav">
                                    <button onclick="closeAllMenus()" style="display:none;" id="mobile-close-btn" class="nav-link-vip"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
                                    <div class="identity-matrix">
                                        <div class="identity-orb-vip" id="ui-avatar-orb">V</div>
                                        <div class="identity-labels">
                                            <h2 id="ui-user-fullname">---</h2>
                                            <span id="ui-user-rank-label" style="display:block; margin-top:5px; color:var(--text-muted-core); font-size:0.9rem;">---</span>
                                        </div>
                                    </div>
                                    
                                    <div class="nav-hub-menu">
                                        <button class="nav-link-vip active" id="tab-live" onclick="switchToAppModule('live')"><i class="fas fa-satellite-dish"></i> Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
                                        <button class="nav-link-vip" id="tab-daily" onclick="switchToAppModule('daily')"><i class="fas fa-calendar-check"></i> ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</button>
                                        <button class="nav-link-vip" id="tab-archive" onclick="switchToAppModule('archive')"><i class="fas fa-database"></i> Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
                                        <button class="nav-link-vip" id="tab-reports" onclick="switchToAppModule('reports')"><i class="fas fa-chart-line"></i> ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙƒÙØ§Ø¡Ø©</button>
                                        <button class="nav-link-vip" id="tab-admin" onclick="switchToAppModule('admin')"><i class="fas fa-crown"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</button>
                                        <button class="nav-link-vip logout-btn-sidebar" onclick="runSystemLogoutSequence()"><i class="fas fa-power-off"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                                    </div>
                                </nav>

                                <div class="vip-master-container">
                                    <button class="hamburger-btn" id="hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                                    <button class="floating-action-master" id="floating-plus-btn" onclick="openSidebarControl()"><i class="fas fa-plus"></i></button>

                                    <!-- Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
                                    <div class="massive-glass-card" style="padding: 15px 25px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; gap: 20px; flex-wrap: wrap;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <i class="fas fa-filter" style="color: var(--gold-master);"></i>
                                            <span style="font-weight: 800;">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹:</span>
                                            <select id="global-branch-filter" onchange="refreshAllModulesData()" style="width: 200px; margin-bottom: 0; padding: 5px 15px;">
                                                <option value="ALL">-- Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹ --</option>
                                            </select>
                                        </div>
                                        <div id="branch-quick-stat" style="color: var(--gold-master); font-weight: 900; font-size: 1.1rem;">
                                            <!-- Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹ -->
                                        </div>
                                    </div>

                                    <!-- LIVE MODULE -->
                                    <div id="module-view-live">
                                        <h1 style="font-size:2rem; margin-bottom:20px; color:var(--text-pure); display:flex; align-items:center; gap:15px;">
                                            <i class="fas fa-satellite-dish" style="color:var(--gold-master)"></i> Ø§Ù„Ø¨Ø« Ø§Ù„Ø­ÙŠ Ù„Ù„Ø¨Ù„Ø§ØºØ§Øª
                                        </h1>
                                        <div id="render-live-feed-matrix" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:20px;"></div>
                                    </div>

                                    <!-- DAILY MODULE -->
                                    <div id="module-view-daily" class="hidden">
                                        <div class="massive-glass-card" style="padding:80px; margin-bottom:80px;">
                                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
                                                <div>
                                                    <h2 style="color:var(--gold-master); font-size:2rem; margin:0;">Ù…Ø­Ø±Ùƒ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
                                                </div>
                                                <div style="width:250px;"><input type="date" id="daily-master-date-picker" style="font-size:1.2rem;" onchange="loadDailySnapshotData()"></div>
                                            </div>
                                            <div id="render-daily-grid-hub" class="daily-matrix-display"></div>
                                        </div>
                                    </div>

                                    <!-- ARCHIVE MODULE -->
                                    <div id="module-view-archive" class="hidden">
                                        <div class="massive-glass-card" style="padding:60px; display:flex; gap:40px; margin-bottom:60px; align-items:flex-end;">
                                            <div style="flex:1;"><label>Ù…Ù†:</label><input type="date" id="archive-date-from"></div>
                                            <div style="flex:1;"><label>Ø¥Ù„Ù‰:</label><input type="date" id="archive-date-to"></div>
                                            <button class="btn-vip-execute-master" style="width:300px;" onclick="runArchiveRefreshSequence()">ØªØ­Ø¯ÙŠØ«</button>
                                        </div>
                                        <div id="render-archive-grid-hub" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(700px, 1fr)); gap:50px;"></div>
                                    </div>

                                    <!-- REPORTS MODULE (ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ) -->
                                    <div id="module-view-reports" class="hidden">
                                        <!-- 1. Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„Ø§ØªØ± -->
                                        <div class="massive-glass-card" style="padding:50px; display:flex; gap:40px; margin-bottom:60px; align-items:flex-end; flex-wrap: wrap;">
                                            <div style="flex:1;"><label>Ù…Ù†:</label><input type="date" id="reports-date-from"></div>
                                            <div style="flex:1;"><label>Ø¥Ù„Ù‰:</label><input type="date" id="reports-date-to"></div>
                                            <div style="flex:1;">
                                                <label>Ø§Ù„ÙØ±Ø¹:</label>
                                                <select id="reports-branch-filter" style="margin-bottom: 0;">
                                                    <option value="ALL">-- Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ --</option>
                                                </select>
                                            </div>
                                            <button class="btn-vip-execute-master" style="width:200px;" onclick="executeAdvancedAnalyticsSequence()">ØªØ­Ù„ÙŠÙ„</button>
                                            <button class="btn-vip-execute-master" style="width:150px; background:var(--accent-navy);" onclick="exportReportsToExcel()">Excel</button>
                                        </div>

                                        <!-- 2. ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
                                        <div id="render-analytics-stat-row" class="stat-cards-grid"></div>

                                        <!-- 3. Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ (ØªÙ… Ù†Ù‚Ù„Ù‡ Ù‡Ù†Ø§ Ù„ÙŠÙƒÙˆÙ† Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰) -->
                                        <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ Ø¨ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ø³Ø¹ ÙˆÙˆØ§Ø¶Ø­ -->
                                        <div class="massive-glass-card" style="padding:30px; margin-bottom:40px; background: rgba(0,0,0,0.2);">
                                            <h3 style="color:var(--gold-master); margin-bottom:25px; text-align:center; font-size:1.5rem;">ØªØ­Ù„ÙŠÙ„ Ø´ÙƒØ§ÙˆÙ‰ Ø§Ù„Ù…Ø·Ø§Ø¹Ù… Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„</h3>
                                            <table id="detailed-complaints-table" style="width:100%; border-collapse:separate; border-spacing: 0; color:white; text-align:center; font-size:0.8rem; border: 1px solid #333;">
                                                <thead>
                                                    <tr style="background:#1d4ed8; position: sticky; top: 0; z-index: 100; color: white;">
                                                        <!-- Ø§Ù„Ù…Ø·Ø¹Ù… (ÙŠÙ…ÙŠÙ†) -->
                                                        <th style="padding:15px; border:1px solid #333; width:150px; position: sticky; right: 0; background:#1d4ed8; z-index: 101;">Ø§Ù„Ù…Ø·Ø¹Ù…</th>

                                                        <!-- Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù€ 15 -->
                                                        <th style="border:1px solid #333; width:80px;">ØªØ£Ø®ÙŠØ±</th>
                                                        <th style="border:1px solid #333; width:80px;">Ø³ÙˆØ¡ Ø®Ø¯Ù…Ø©</th>
                                                        <th style="border:1px solid #333; width:80px;">Ù†Ø§Ù‚Øµ</th>
                                                        <th style="border:1px solid #333; width:80px;">Ø³ÙˆØ¡ ØªØ¹Ø¨Ø¦Ø©</th>
                                                        <th style="border:1px solid #333; width:100px;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨</th>
                                                        <th style="border:1px solid #333; width:100px;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ</th>
                                                        <th style="border:1px solid #333; width:80px;">Ø¬ÙˆØ¯Ø©</th>
                                                        <th style="border:1px solid #333; width:80px;">Ø¬Ø³Ù… ØºØ±ÙŠØ¨</th>
                                                        <th style="border:1px solid #333; width:80px;">Ø³ÙˆØ¡ Ø³Ù„ÙˆÙƒ</th>
                                                        <th style="border:1px solid #333; width:80px;">Ù…Ù†Ø¯ÙˆØ¨</th>
                                                        <th style="border:1px solid #333; width:80px;">Ø·Ù„Ø¨ Ø¨Ø§Ø±Ø¯</th>
                                                        <th style="border:1px solid #333; width:80px;">Ø±Ø³ÙŠØ¨ÙŠ</th>
                                                        <th style="border:1px solid #333; width:100px;">ØªØ£Ø®ÙŠØ± Ø´ÙƒÙˆÙ‰</th>
                                                        <th style="border:1px solid #333; width:120px;">ØªÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„ÙØ±Ø¹</th>
                                                        <th style="border:1px solid #333; width:80px;">Ø³ÙˆØ´ÙŠØ§Ù„</th>

                                                        <!-- Ø£Ø¹Ù…Ø¯Ø© Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© -->
                                                        <th style="border:1px solid #333; width:70px; background:#333;">HD</th>
                                                        <th style="border:1px solid #333; width:70px; background:#333;">Din In</th>
                                                        <th style="border:1px solid #333; width:70px; background:#333;">PK</th>
                                                        <th style="border:1px solid #333; width:70px; background:#333;">TA</th>

                                                        <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ø¹Ù… (ÙŠØ³Ø§Ø±) - Ù„ÙˆÙ† Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ -->
                                                        <th style="padding:15px; border:1px solid #333; width:120px; position: sticky; left: 0; background: #f59e0b; color: #000; font-weight: 950; z-index: 101;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ø¹Ù…</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="complaints-table-body">
                                                    <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
                                                </tbody>
                                            </table>
                                        </div>

                                        <!-- 4. Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© (Ø£ØµØ¨Ø­Øª Ø¨Ø§Ù„Ø£Ø³ÙÙ„) -->
                                        <div class="analytics-dual-layout">
                                            <div class="massive-glass-card chart-viewport-massive"><canvas id="master-reports-canvas" style="max-height: 500px;"></canvas></div>
                                            <div class="massive-glass-card chart-viewport-massive">
                                                <div style="height: 400px; display:flex; justify-content:center;"><canvas id="master-types-canvas"></canvas></div>
                                            </div>
                                        </div>

                                        <!-- 5. Ø¬Ø¯ÙˆÙ„ ÙƒÙØ§Ø¡Ø© Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ -->
                                        <div class="massive-glass-card" style="padding:20px; margin-top:40px; max-width:600px;">
                                            <h3 style="color:var(--gold-master); margin-bottom:15px;">Ù†Ø³Ø¨Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ù„Ù„ÙØ±ÙˆØ¹</h3>
                                            <table style="width:100%; border-collapse:collapse; text-align:center;" id="efficiency-table">
                                                <thead>
                                                    <tr style="background:#222;">
                                                        <th style="padding:10px; border:1px solid #444;">Ø§Ù„Ù…Ø·Ø¹Ù…</th>
                                                        <th style="border:1px solid #444;">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
                                                        <th style="border:1px solid #444;">Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</th>
                                                        <th style="border:1px solid #444;">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="efficiency-table-body"></tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- ADMIN MODULE (UPDATED WITH PRESENCE & LOGS) -->
                                    <div id="module-view-admin" class="hidden">
                                        
                                        <div class="massive-glass-card" style="padding:40px; margin-bottom:40px; border-top: 5px solid var(--success-glow);">
                                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:15px;">
                                                <h3 style="color:var(--success-glow); font-size:1.8rem; margin:0; display:flex; align-items:center; gap:10px;">
                                                    <i class="fas fa-satellite-dish"></i> Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø­ÙŠØ©
                                                </h3>

                                                <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹ Ù„Ù„Ø±Ø§Ø¯Ø§Ø± -->
                                                <div style="display:flex; align-items:center; gap:10px;">
                                                    <span style="color:var(--text-muted-core);">Ø¹Ø±Ø¶ ÙØ±Ø¹:</span>
                                                    <select id="radar-branch-filter-select" onchange="initPresenceMonitor()" style="width:200px; margin:0; padding:5px 10px;">
                                                        <option value="SHOW_ALL">-- Ø§Ù„ÙƒÙ„ --</option>
                                                        <option value="ALL">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</option>
                                                        <!-- Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø¨Ø§Ù‚ÙŠØ© Ù‡ØªØ¶Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
                                                    </select>
                                                </div>
                                            </div>

                                            <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø±Ø§Ø¯Ø§Ø± -->
                                            <div id="adm-presence-grid" class="presence-grid" style="min-height:100px;">
                                                <!-- Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù‡ÙŠØ¸Ù‡Ø±ÙˆØ§ Ù‡Ù†Ø§ -->
                                            </div>
                                        </div>

                                        <div class="massive-glass-card" style="padding:30px; margin-top:30px; border-bottom: 4px solid var(--gold-master);">
                                            <h3 style="color:var(--gold-master); margin-bottom:25px;"><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>

                                            <!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„Ø§ØªØ± -->
                                            <div style="display:flex; gap:10px; margin-bottom:20px; flex-direction: row-reverse;">
                                                <input type="text" id="log-search-name" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." style="flex:2; margin:0;" onkeyup="applyLogsFilter()">
                                                <input type="date" id="log-filter-date" style="flex:1; margin:0;" onchange="applyLogsFilter()">
                                                <select id="log-filter-branch" style="flex:1; margin:0;" onchange="applyLogsFilter()">
                                                    <option value="">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
                                                </select>
                                                <button class="btn-vip-execute-master" style="width:auto; padding:0 20px;" onclick="resetLogsFilter()">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
                                            </div>

                                            <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
                                            <div style="border: 1px solid rgba(255,255,255,0.1); border-radius:10px; overflow:hidden;">
                                                <div class="log-table-row log-header">
                                                    <div>Ø§Ù„Ù…ÙˆØ¸Ù</div>
                                                    <div>Ø§Ù„Ø­Ø¯Ø« (ÙØªØ­/Ù‚ÙÙ„)</div>
                                                    <div>Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¯Ù‚ÙŠÙ‚</div>
                                                    <div>Ø§Ù„ÙØ±Ø¹</div>
                                                </div>
                                                <div id="adm-access-logs-list" class="scrollable-admin-list">
                                                    <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                                                </div>
                                            </div>

                                            <button class="btn-vip-execute-master" style="background:var(--danger-pulse); width:auto; margin-top:15px; font-size:0.8rem;" onclick="clearAllSystemLogs()">
                                                <i class="fas fa-trash"></i> ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„
                                            </button>
                                        </div>

                                        <div class="admin-layout-flex">
                                            <div class="massive-glass-card" style="padding:80px;">
                                                <h3 style="color:var(--gold-master); margin-bottom:60px;">Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙØ±ÙˆØ¹</h3>
                                                <div style="display:flex; gap:25px; margin-bottom:40px;">
                                                    <input id="adm-branch-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹">
                                                    <button class="btn-vip-execute-master" style="width:180px;" onclick="addSystemBranchCore()">Ø¥Ø¯Ø±Ø§Ø¬</button>
                                                </div>
                                                <div id="adm-branches-scroll-box" class="scrollable-admin-list"></div>
                                                <hr style="margin:50px 0; border-color:var(--border-glow-line);">
                                                <h3 style="color:var(--gold-master); margin-bottom:40px;">ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
                                                <select id="adm-whatsapp-br-sel" onchange="renderBranchWhatsappList()"></select>
                                                <div style="display:flex; gap:25px;">
                                                    <input id="adm-whatsapp-phone-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                                                    <button class="btn-vip-execute-master" style="width:180px;" onclick="bindNewWhatsappToBranch()">+ Ø±Ø¨Ø·</button>
                                                </div>
                                                <div id="adm-whatsapp-scroll-box" class="scrollable-admin-list" style="margin-top:40px;"></div>
                                            </div>

                                            <div class="massive-glass-card" style="padding:80px;">
                                                <h3 style="color:var(--gold-master); margin-bottom:60px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h3>
                                                <div style="display:flex; gap:25px; margin-bottom:40px;">
                                                    <input id="adm-rank-name-input" placeholder="Ø±ØªØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©">
                                                    <button class="btn-vip-execute-master" style="width:180px;" onclick="registerNewRankTitleCore()">Ø¥Ø¶Ø§ÙØ©</button>
                                                </div>
                                                <select id="adm-rank-matrix-sel" onchange="loadRankPermissionsMatrixHub()"></select>
                                                <div id="adm-permissions-grid-hub" class="hidden" style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; background:rgba(0,0,0,0.6); padding:40px; border-radius:20px; margin-top:35px;">
                                                    <label><input type="checkbox" id="perm-view-all"> Ø±Ø¤ÙŠØ© Ø´Ø§Ù…Ù„Ø©</label>
                                                    <label><input type="checkbox" id="perm-create-ticket"> Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„Ø§ØºØ§Øª</label>
                                                    <label><input type="checkbox" id="perm-reply-ticket"> ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø¯</label>
                                                    <label><input type="checkbox" id="perm-daily-edit"> ØªØ­Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</label>
                                                    <label><input type="checkbox" id="perm-admin-access"> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
                                                    <button class="btn-vip-execute-master" style="grid-column: span 2;" onclick="saveRankPermissionsSequence()">ØªØ«Ø¨ÙŠØª</button>
                                                </div>
                                                <hr style="margin:60px 0; border-color:var(--border-glow-line);">
                                                <h3 style="color:var(--gold-master);">ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¶Ùˆ</h3>
                                                <input id="reg-user-id-core" placeholder="ID">
                                                <input id="reg-user-fullname-core" placeholder="Ø§Ù„Ø§Ø³Ù…">
                                                <select id="reg-user-rank-sel-core"></select>
                                                <select id="reg-user-branch-sel-core"></select>
                                                <input id="reg-user-pass-core" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                                                <button class="btn-vip-execute-master" onclick="registerNewUserToSystemSequence()">ØªÙØ¹ÙŠÙ„</button>
                                                <div id="adm-users-scroll-box" class="scrollable-admin-list" style="margin-top:50px;"></div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- Sidebar Complaint Form -->
                            <div id="sidebar-complaint-arc-hub" class="sidebar-complaint-master">
                                <h2 style="color:var(--gold-master); font-size:2rem; margin-bottom:30px;">ØªØ­Ø±ÙŠØ± Ù…Ø°ÙƒØ±Ø© Ø¨Ù„Ø§Øº</h2>
                                <label>Ø§Ù„ÙØ±Ø¹</label><select id="f-branch-master-sel"></select>
                                <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="f-date-master">
                                <label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                                <select id="f-service-type-sel">
                                    <option value="HD">ØªÙˆØµÙŠÙ„ (HD)</option>
                                    <option value="Din In">Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø·Ø¹Ù… (Din In)</option>
                                    <option value="PK">ØªÙŠÙƒ Ø£ÙˆÙŠ (PK)</option>
                                    <option value="TA">ØªÙˆØµÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ (TA)</option>
                                </select>
                                <label>Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¯Ù‚ÙŠÙ‚</label>
                                <select id="f-complaint-type-sel">
                                    <option>ØªØ£Ø®ÙŠØ±</option>
                                    <option>Ø³ÙˆØ¡ Ø®Ø¯Ù…Ø©</option>
                                    <option>Ù†Ø§Ù‚Øµ</option>
                                    <option>Ø³ÙˆØ¡ ØªØ¹Ø¨Ø¦Ø©</option>
                                    <option>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨</option>
                                    <option>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ</option>
                                    <option>Ø¬ÙˆØ¯Ø©</option>
                                    <option>Ø¬Ø³Ù… ØºØ±ÙŠØ¨</option>
                                    <option>Ø³ÙˆØ¡ Ø³Ù„ÙˆÙƒ</option>
                                    <option>Ù…Ù†Ø¯ÙˆØ¨</option>
                                    <option>Ø·Ù„Ø¨ Ø¨Ø§Ø±Ø¯</option>
                                    <option>Ø±Ø³ÙŠØ¨ÙŠ</option>
                                    <option>ØªØ£Ø®ÙŠØ± Ø´ÙƒÙˆÙ‰</option>
                                    <option>ØªÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„ÙØ±Ø¹</option>
                                    <option>Ø³ÙˆØ´ÙŠØ§Ù„</option>
                                </select>
                                <label>Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label><input id="f-order-id-input" placeholder="#0000">
                                <label>Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input id="f-customer-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                                <label>Ø§Ù„ØªÙØ§ØµÙŠÙ„</label><textarea id="f-complaint-msg-input" rows="4"></textarea>
                                <button class="btn-vip-execute-master" onclick="runComplaintTicketSequence()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</button>
                            </div>



                            <script>
                                /* 
                                ========================================================================
                                --- INTERNAL CORE LOGIC V47.0 (PRESENCE + LOGS + HOVER UI) --- 
                                ========================================================================
                                */


                                let currentUserSession = null;
                                let complaintsCache = {};
                                let systemSettingsCache = {};
                                let branchListCache = [];
                                let analyticsChartInstance = null;
                                let analyticsTypeChartInstance = null;
                                let allAccessLogsCache = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ø³Ø±Ø¹Ø© Ø§Ù„ÙÙ„ØªØ±Ø©
                                let isFirstLoad = true;

                            async function runSecurityAuthSequence() {
                                // --- ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ Ù„ÙÙƒ Ø­Ø¸Ø± Ø§Ù„ØµÙˆØª ---
                                const audio = document.getElementById("notification-sound");
                                if(audio) {
                                    audio.play().then(() => {
                                        audio.pause();
                                        audio.currentTime = 0;
                                    }).catch(e => console.log("Audio permission needed"));
                                }
                                // ----------------------------

                                const uid = document.getElementById('auth-uid-master').value.trim();
                                const pwd = document.getElementById('auth-pwd-master').value.trim();

                                if(!uid || !pwd) { renderSystemToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!", "danger"); return; }

                                // Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†
                                if(uid === 'super' && pwd === 'vip2026') {
                                    const adminData = { id: 'super', name: 'Super Administrator', title: 'ROOT-COMMAND', branch: 'ALL', role: 'SUPER' };

                                    grantCoreAccess(adminData);
                                    return;
                                }

                                // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø­Ø« ÙÙŠ localStorageØŒ Ø§Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                const snap = await dbHub.ref('users/' + uid).once('value');
                                const user = snap.val();

                                if(user && user.pass === pwd) {
                                    const userData = { id: uid, ...user, role: (uid === 'super' ? 'SUPER' : 'USER') };
                                    if(uid === 'super') userData.branch = 'ALL'; // ÙØ±Ø¶ ÙØ±Ø¹ ALL Ù„Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†
                                    grantCoreAccess(userData);
                                } else {
                                    Swal.fire('Ø®Ø·Ø£', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø© Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error');
                                }
                            }

                                function grantCoreAccess(data) {
                                    localStorage.setItem('vip_v43_secure_token', JSON.stringify(data));

                                    // Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø© "Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†" ÙÙˆØ±Ø§Ù‹ Ø¥Ù„Ù‰ Firebase
                                    const presenceRef = dbHub.ref('users_presence/' + data.id);
                                    const logsRef = dbHub.ref('access_logs');

                                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
                                    presenceRef.set({
                                        state: 'online',
                                        name: data.name,
                                        title: data.title,
                                        branch: data.branch,
                                        last_changed: firebase.database.ServerValue.TIMESTAMP
                                    });

                                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù„ÙˆØ¬ (ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹)
                                    logsRef.push({
                                        user: data.name,
                                        uid: data.id,
                                        branch: data.branch,
                                        action: 'ğŸŸ¢ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (ONLINE)',
                                        timestamp: firebase.database.ServerValue.TIMESTAMP
                                    });

                                    // Ø¥Ø¹Ø¯Ø§Ø¯ "Ù…Ø³Ø­ Ø§Ù„Ø­Ø§Ù„Ø©" Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø£Ùˆ Ù‚ÙÙ„ Ø§Ù„ØµÙØ­Ø©
                                    presenceRef.onDisconnect().update({
                                        state: 'offline',
                                        last_changed: firebase.database.ServerValue.TIMESTAMP
                                    });

                                    // ØªØ³Ø¬ÙŠÙ„ "Ù„ÙˆØ¬ Ø§Ù„Ø®Ø±ÙˆØ¬" Ø¹Ù†Ø¯ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
                                    const disconnectLogRef = logsRef.push();
                                    disconnectLogRef.onDisconnect().set({
                                        user: data.name,
                                        uid: data.id,
                                        branch: data.branch,
                                        action: 'ğŸ”´ Ø£ØºÙ„Ù‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (OFFLINE)',
                                        timestamp: firebase.database.ServerValue.TIMESTAMP
                                    });

                                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©
                                    location.reload();
                                }

                                function runSystemLogoutSequence() {
                                    localStorage.removeItem('vip_v43_secure_token');
                                    location.reload();
                                }

                                function activateUserPresenceTracking(userData) {
                                    if (!userData || !userData.id) return;

                                    const presenceRef = dbHub.ref('users_presence/' + userData.id);
                                    const logsRef = dbHub.ref('access_logs');
                                    const connectedRef = dbHub.ref('.info/connected');

                                    connectedRef.on('value', (snap) => {
                                        if (snap.val() === true) {
                                            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„ÙØ±Ø¹
                                            logsRef.push({
                                                uid: userData.id,
                                                user: userData.name,
                                                branch: userData.branch, // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ Ù‡Ù†Ø§
                                                action: "ğŸŸ¢ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (ONLINE)",
                                                timestamp: firebase.database.ServerValue.TIMESTAMP
                                            });

                                            const offlineLogRef = logsRef.push();
                                            offlineLogRef.onDisconnect().set({
                                                uid: userData.id,
                                                user: userData.name,
                                                branch: userData.branch, // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ Ù‡Ù†Ø§
                                                action: "ğŸ”´ ØºØ§Ø¯Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ (OFFLINE)",
                                                timestamp: firebase.database.ServerValue.TIMESTAMP
                                            });

                                            presenceRef.onDisconnect().update({
                                                state: 'offline',
                                                last_changed: firebase.database.ServerValue.TIMESTAMP
                                            });

                                            presenceRef.set({
                                                state: 'online',
                                                name: userData.name,
                                                title: userData.title,
                                                branch: userData.branch, // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ Ù‡Ù†Ø§ Ù„Ù„Ø±Ø§Ø¯Ø§Ø±
                                                last_changed: firebase.database.ServerValue.TIMESTAMP
                                            });
                                        }
                                    });
                                }

                                window.onload = () => {
                                    const sess = localStorage.getItem('vip_v43_secure_token');
                                    if(sess) {
                                        currentUserSession = JSON.parse(sess);
                                        document.getElementById('auth-portal-mask').classList.add('hidden');
                                        document.getElementById('main-system-viewport').classList.remove('hidden');
                                        document.getElementById('ui-user-fullname').innerText = currentUserSession.name;
                                        document.getElementById('ui-user-rank-label').innerText = currentUserSession.title;
                                        document.getElementById('ui-avatar-orb').innerText = currentUserSession.name.charAt(0);

                                        // Ø¶Ø¨Ø· Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                                        const todayStr = new Date().toISOString().split('T')[0];
                                        const dateInputs = ['daily-master-date-picker', 'archive-date-from', 'archive-date-to', 'reports-date-from', 'reports-date-to', 'f-date-master'];
                                        dateInputs.forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = todayStr; });

                                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
                                        branchListCache = JSON.parse(localStorage.getItem('branches') || '[]');
                                        systemSettingsCache.custom_ranks = JSON.parse(localStorage.getItem('custom_ranks') || '{}');
                                        systemSettingsCache.permissions = JSON.parse(localStorage.getItem('permissions') || '{}');

                                        syncUiDropdownSelections();
                                        renderAdminBranchScrollBox();
                                        renderAdminUsersScrollBox();

                                        runPermissionShieldCheck(); // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª

                                        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªØªØ¨Ø¹ Ø§Ù„ØªÙˆØ§Ø¬Ø¯ ÙÙˆØ±Ø§Ù‹
                                        activateUserPresenceTracking(currentUserSession);
                                        initPresenceMonitor(); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†
                                        initCoreDataListeners();
                                    }
                                };

                                async function initPresenceMonitor() {
                                    const radarFilter = document.getElementById('radar-branch-filter-select');
                                    const selectedBranch = radarFilter ? radarFilter.value : "SHOW_ALL";

                                    if (radarFilter) {
                                        radarFilter.innerHTML = '<option value="SHOW_ALL">-- Ø§Ù„ÙƒÙ„ --</option><option value="ALL">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</option>' + branchListCache.map(b => `<option value="${b}">${b}</option>`).join('');
                                        radarFilter.value = selectedBranch;
                                    }

                                    // 1. Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
                                    const usersSnap = await dbHub.ref('users').once('value');
                                    const allUsers = usersSnap.val() || {};

                                    // 2. Ø³Ù…Ø§Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­ÙŠØ© (Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø§Ù„Ø¢Ù†)
                                    dbHub.ref('users_presence').on('value', snap => {
                                        const presenceData = snap.val() || {};
                                        const grid = document.getElementById('adm-presence-grid');
                                        if(!grid) return;
                                        grid.innerHTML = '';

                                        // ØªØ­Ø¶ÙŠØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
                                        let userList = [];

                                        // Ù†Ù…Ø± Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† (allUsers)
                                        Object.keys(allUsers).forEach(uid => {
                                            const user = allUsers[uid];

                                            // ÙÙ„ØªØ± Ø§Ù„ÙØ±Ø¹
                                            if (selectedBranch === "SHOW_ALL" || user.branch === selectedBranch) {
                                                // Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„ØªÙ‡ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØ§Ø¬Ø¯
                                                const presenceInfo = presenceData[uid] || {};
                                                const isOnline = presenceInfo.state === 'online';

                                                userList.push({
                                                    uid: uid,
                                                    name: user.name,
                                                    branch: user.branch,
                                                    rank: user.title,
                                                    isOnline: isOnline
                                                });
                                            }
                                        });

                                        if (userList.length === 0) {
                                            grid.innerHTML = `<div style="color:var(--text-muted-core); padding:20px; text-align:center; width:100%;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹</div>`;
                                            return;
                                        }

                                        // ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø£ÙˆÙ„
                                        userList.sort((a, b) => b.isOnline - a.isOnline);

                                        // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙˆØ£ÙˆÙÙ„Ø§ÙŠÙ†)
                                        userList.forEach(u => {
                                            grid.innerHTML += `
                                                <div class="presence-user-orb ${u.isOnline ? 'orb-online' : 'orb-offline'}"
                                                    style="opacity: ${u.isOnline ? '1' : '0.5'};"
                                                    onclick="viewUserProfileActivity('${u.uid}', '${u.name}')">
                                                    <div class="avatar-ring" style="border-color: ${u.isOnline ? '#39d353' : '#484f58'}">
                                                        ${u.name ? u.name.charAt(0) : '?'}
                                                        <div class="status-indicator" style="background: ${u.isOnline ? '#39d353' : '#484f58'}"></div>
                                                    </div>
                                                    <div class="user-name-label" style="color: ${u.isOnline ? '#fff' : '#8b949e'}">${u.name}</div>
                                                    <div style="font-size:0.7rem; color:var(--gold-master); opacity:0.8;">${u.rank || ''}</div>
                                                </div>`;
                                        });
                                    });
                                }

                                function applyLogsFilter() {
                                    // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ÙÙ„ØªØ±
                                    const searchName = document.getElementById('log-search-name').value.toLowerCase();
                                    const filterDate = document.getElementById('log-filter-date').value;
                                    const filterBranch = document.getElementById('log-filter-branch').value;
                                    const list = document.getElementById('adm-access-logs-list');

                                    if(!list) return;
                                    list.innerHTML = '';

                                    // ØªØµÙÙŠØ© Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ù€ 3
                                    const filtered = allAccessLogsCache.filter(log => {
                                        const matchesName = log.user.toLowerCase().includes(searchName);

                                        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù€ timestamp Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© yyyy-mm-dd Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
                                        const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                                        const matchesDate = filterDate ? (logDate === filterDate) : true;

                                        // Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ÙØ±Ø¹ (Ù„Ùˆ "ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹" ÙŠØ¨Ù‚Ù‰ ÙØ§Ø¶ÙŠ ÙˆÙŠØ¹Ø¯ÙŠ Ø§Ù„ÙƒÙ„)
                                        const matchesBranch = (filterBranch === "" || filterBranch === "ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹") ? true : (log.branch === filterBranch);

                                        return matchesName && matchesDate && matchesBranch;
                                    });

                                    if (filtered.length === 0) {
                                        list.innerHTML = `<div style="text-align:center; padding:50px; color:var(--text-muted-core);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</div>`;
                                        return;
                                    }

                                    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                                    filtered.forEach(log => {
                                        const d = new Date(log.timestamp);
                                        const timeStr = d.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                                        const isOnline = log.action.includes('ONLINE') || log.action.includes('ÙØªØ­');

                                        list.innerHTML += `
                                            <div class="log-table-row">
                                                <div style="font-weight:600;">${log.user}</div>
                                                <div style="color:${isOnline ? 'var(--success-glow)' : '#ef4444'}">
                                                    <i class="fas ${isOnline ? 'fa-sign-in-alt' : 'fa-sign-out-alt'}"></i> ${log.action}
                                                </div>
                                                <div style="direction:ltr; font-family:monospace; font-size:0.85rem;">${timeStr}</div>
                                                <div style="color:var(--gold-master);">${log.branch || '---'}</div>
                                            </div>`;
                                    });
                                }

                                // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· (Ø²Ø± "Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·")
                                function resetLogsFilter() {
                                    document.getElementById('log-search-name').value = '';
                                    document.getElementById('log-filter-date').value = '';
                                    document.getElementById('log-filter-branch').value = '';
                                    applyLogsFilter(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³Ø­
                                }

                                // === ÙˆØ¸ÙŠÙØ© Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù (Ø¹Ø±Ø¶ Ø§Ù„ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡) ===
                                async function viewUserProfileActivity(uid, userName) {
                                    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                                    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

                                    // Ø¬Ù„Ø¨ Ø¢Ø®Ø± 50 Ø³Ø¬Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©
                                    const snap = await dbHub.ref('access_logs').orderByChild('uid').equalTo(uid).limitToLast(50).once('value');
                                    const logsData = snap.val();
                                    
                                    let timelineHtml = `<div style="text-align:right; max-height:400px; overflow-y:auto; padding:10px; direction:rtl;">`;
                                    
                                    if(!logsData) {
                                        timelineHtml += `<p style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù†Ø´Ø§Ø· Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø¹Ø¯.</p>`;
                                    } else {
                                        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ù…ØµÙÙˆÙØ© ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
                                        const sortedLogs = Object.values(logsData).sort((a, b) => b.timestamp - a.timestamp);
                                        
                                        sortedLogs.forEach(l => {
                                            const dateObj = new Date(l.timestamp);
                                            const time = dateObj.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
                                            const date = dateObj.toLocaleDateString('ar-EG');
                                            const isOnline = l.action.includes('ONLINE');
                                            
                                            timelineHtml += `
                                                <div style="border-bottom:1px solid #30363d; padding:12px 0; display:flex; justify-content:space-between; align-items:center;">
                                                    <div>
                                                        <span style="color:${isOnline ? '#39d353' : '#f85149'}; font-size:1.1rem; margin-left:10px;">
                                                            ${isOnline ? 'â—' : 'â—'}
                                                        </span>
                                                        <b style="color:#f0f6fc;">${l.action.split('(')[0]}</b>
                                                    </div>
                                                    <div style="text-align:left;">
                                                        <div style="font-size:0.85rem; color:#f0f6fc;">${time}</div>
                                                        <div style="font-size:0.7rem; color:#8b949e;">${date}</div>
                                                    </div>
                                                </div>`;
                                        });
                                    }
                                    timelineHtml += `</div>`;

                                    Swal.fire({
                                        title: `<span style="color:#f59e0b">Ù…Ù„Ù Ù†Ø´Ø§Ø·: ${userName}</span>`,
                                        html: timelineHtml,
                                        confirmButtonText: 'Ø¥ØºÙ„Ø§Ù‚',
                                        confirmButtonColor: '#21262d',
                                        background: '#0d1117',
                                        color: '#f0f6fc',
                                        width: '450px'
                                    });
                                }

                                function checkForNewComplaintsAndPlaySound(newOps) {
                                    let triggered = false;

                                    // 1. Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù† Ù…Ù† Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„ØµÙˆØªÙŠ ØªÙ…Ø§Ù…Ø§Ù‹
                                    if (currentUserSession.role === 'SUPER') return;

                                    // 2. Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ù…ÙˆØ¸ÙÙŠ Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ù„Ø°ÙŠÙ† ÙØ±Ø¹Ù‡Ù… ALL) Ù…Ù† Ø§Ù„Ø¥Ù†Ø°Ø§Ø±
                                    if (currentUserSession.branch === 'ALL') return;

                                    Object.keys(newOps).forEach(id => {
                                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯ (ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙƒØ§Ø´)
                                        if (!complaintsCache[id]) {
                                            const ticket = newOps[id];

                                            // 3. Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ÙŠØ´ØªØºÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ±Ø¹ Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø·Ø§Ø¨Ù‚ Ù„ÙØ±Ø¹ Ø§Ù„Ø¨Ù„Ø§Øº
                                            if (currentUserSession.branch === ticket.branch) {
                                                triggered = true;
                                            }
                                        }
                                    });

                                    if (triggered) {
                                        triggerRedAlarm(); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø£Ø­Ù…Ø± ÙˆØ§Ù„ØµÙˆØª
                                    }
                                }

                                // Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±
                                function triggerRedAlarm() {
                                    const overlay = document.getElementById('red-alarm-overlay');
                                    const audio = document.getElementById('notification-sound');

                                    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡
                                    overlay.classList.remove('hidden');
                                    overlay.style.display = 'flex'; // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¸Ù‡Ø§Ø±

                                    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ø´ÙƒÙ„ Ù…ØªÙƒØ±Ø± (Loop)
                                    if (audio) {
                                        audio.loop = true; // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±
                                        audio.currentTime = 0;
                                        audio.play().catch(e => console.log("User interaction needed for audio"));
                                    }
                                }

                                // Ø¯Ø§Ù„Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ù†Ø°Ø§Ø± (Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ø§Ù„Ø²Ø±)
                                function stopAlarmAndShowTicket() {
                                    const overlay = document.getElementById('red-alarm-overlay');
                                    const audio = document.getElementById('notification-sound');

                                    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡
                                    overlay.classList.add('hidden');
                                    overlay.style.display = 'none';

                                    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª
                                    if (audio) {
                                        audio.pause();
                                        audio.currentTime = 0;
                                        audio.loop = false; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙƒØ±Ø§Ø±
                                    }

                                    // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                                    switchToAppModule('live');
                                    // Ø¹Ù…Ù„ Ø³ÙƒØ±ÙˆÙ„ Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯
                                    window.scrollTo({ top: 0, behavior: 'smooth' });
                                }

                                function playNotificationSound() {
                                    const audio = document.getElementById("notification-sound");
                                    if (audio) {
                                        audio.currentTime = 0; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØµÙˆØª Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©
                                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ØªØªØ·Ù„Ø¨ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹)
                                        const playPromise = audio.play();
                                        if (playPromise !== undefined) {
                                            playPromise.catch(error => {
                                                console.log("Auto-play was prevented by browser logic.");
                                            });
                                        }
                                    }
                                }

                                function initCoreDataListeners() {
                                    dbHub.ref('settings').on('value', snap => {
                                        systemSettingsCache = snap.val() || {};
                                        if (!systemSettingsCache.branches) {
                                            systemSettingsCache.branches = {
                                                'branch1': 'ÙØ±Ø¹ 1',
                                                'branch2': 'ÙØ±Ø¹ 2',
                                                'branch3': 'ÙØ±Ø¹ 3'
                                            };
                                        }
                                        branchListCache = Object.values(systemSettingsCache.branches);
                                        if(!systemSettingsCache.custom_ranks) systemSettingsCache.custom_ranks = {};
                                        ['Ø¯ÙŠØ³Ø¨ØªØ´Ø±', 'Ù…Ø¯ÙŠØ± ÙØ±Ø¹', 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', 'ÙƒÙˆÙ„ Ø³Ù†ØªØ±'].forEach(r => { if(!systemSettingsCache.custom_ranks[r]) systemSettingsCache.custom_ranks[r] = true; });

                                        // Ø­ÙØ¸ Ø§Ù„Ø±ØªØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Firebase Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                                        if (Object.keys(systemSettingsCache.custom_ranks).length === 0) {
                                            const defaultRanks = {
                                                'Ø¯ÙŠØ³Ø¨ØªØ´Ø±': true,
                                                'Ù…Ø¯ÙŠØ± ÙØ±Ø¹': true,
                                                'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©': true,
                                                'ÙƒÙˆÙ„ Ø³Ù†ØªØ±': true
                                            };
                                            dbHub.ref('settings/custom_ranks').set(defaultRanks);
                                        }

                                        syncUiDropdownSelections();
                                        renderAdminBranchScrollBox();
                                        renderAdminUsersScrollBox();
                                        renderBranchWhatsappList();
                                        loadDailySnapshotData();
                                        runPermissionShieldCheck();
                                    });
                                    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±ØªØ¨ ÙÙˆØ±Ø§Ù‹ Ù…Ù† Firebase
                                    dbHub.ref('settings/custom_ranks').on('value', snap => {
                                        const ranks = snap.val() || {};
                                        if (!systemSettingsCache) systemSettingsCache = {};
                                        systemSettingsCache.custom_ranks = ranks;

                                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙÙˆØ±Ø§Ù‹ ÙÙŠ ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø©
                                        syncUiDropdownSelections();
                                        console.log("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØªØ¨ Ø­ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±");
                                    });
                                    dbHub.ref('operations').on('value', snap => {
                                        const newOperations = snap.val() || {};

                                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ø°Ù‡ Ø£ÙˆÙ„ Ù…Ø±Ø© ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©)
                                        if (!isFirstLoad) {
                                            checkForNewComplaintsAndPlaySound(newOperations);
                                        }

                                        complaintsCache = newOperations;
                                        renderLiveBroadcastMatrix();
                                        runArchiveRefreshSequence();

                                        // Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ØŒ Ù†ØºÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„ØµÙˆØª ÙÙŠ Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
                                        isFirstLoad = false;
                                    });
                                    // 3. Ø³Ù…Ø§Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ initPresenceMonitor Ø£Ùˆ window.onload)
                                    dbHub.ref('access_logs').limitToLast(150).on('value', snap => {
                                        allAccessLogsCache = [];
                                        snap.forEach(child => {
                                            allAccessLogsCache.push({ id: child.key, ...child.val() });
                                        });
                                        allAccessLogsCache.reverse(); // Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙˆÙ‚
                                        applyLogsFilter(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙÙˆØ±Ø§Ù‹
                                    });

                                    // Listener for config to update admin UI
                                    dbHub.ref('config').on('value', snap => {
                                        const currentConfig = snap.val() || {};
                                        
                                        const elementsToUpdate = {
                                            'admin-in-phone': currentConfig.payPhone,
                                            'admin-in-acc': currentConfig.accNumber,
                                            'admin-in-name': currentConfig.accName,
                                            'admin-in-grace': currentConfig.graceDays
                                        };

                                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø§Ù†Ø§Øª ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
                                        for (const [id, val] of Object.entries(elementsToUpdate)) {
                                            const el = document.getElementById(id);
                                            if (el) el.value = val || "";
                                        }

                                        const lockBtn = document.getElementById('admin-lock-btn');
                                        if (lockBtn) {
                                            lockBtn.innerHTML = currentConfig.manualLocked ? '<i class="fas fa-unlock"></i> ÙØªØ­ ÙŠØ¯ÙˆÙŠØ§Ù‹' : '<i class="fas fa-lock"></i> Ù‚ÙÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹';
                                            lockBtn.style.background = currentConfig.manualLocked ? "#10b981" : "#ef4444";
                                        }
                                    });
                                }

                                async function loadDailySnapshotData() {
                                    const dateStr = document.getElementById('daily-master-date-picker').value;
                                    const gridBox = document.getElementById('render-daily-grid-hub');
                                    gridBox.innerHTML = `<h2 style="grid-column:1/-1;text-align:center;padding:100px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>`;
                                    const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
                                    const canEdit = p.daily_edit || currentUserSession.role === 'SUPER';
                                    const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';
                                    const dSnap = await dbHub.ref(`daily_stats/${dateStr}`).get();
                                    const dailyData = dSnap.val() || {};
                                    const userBranch = currentUserSession.branch;
                                    const isSuper = currentUserSession.role === 'SUPER' || userBranch === 'ALL';
                                    gridBox.innerHTML = "";
                                    branchListCache.forEach(branch => {
                                        // --- Ø¹Ø²Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ---
                                        if(!isSuper && branch !== userBranch) return;
                                        // ------------------

                                        gridBox.innerHTML += `<div class="massive-glass-card branch-data-card"><h4 style="font-size:2.5rem;">${branch}</h4><input type="number" class="massive-daily-input" value="${dailyData[branch] || 0}" ${canEdit?'':'disabled'} onchange="commitDailyOrderValue('${dateStr}','${branch}',this.value)"><div style="margin-top:20px;color:var(--text-muted-core);">Ø£ÙˆØ±Ø¯Ø±Ø§Øª ${dateStr}</div></div>`;
                                    });
                                }

                                async function commitDailyOrderValue(date, br, val) {
                                    if(val < 0) { renderSystemToast("Ø®Ø·Ø£: Ù‚ÙŠÙ…Ø© Ø³Ø§Ù„Ø¨Ø©", "danger"); return; }
                                    await dbHub.ref(`daily_stats/${date}/${br}`).set(val);
                                    renderSystemToast("ØªÙ… Ø§Ù„Ø­ÙØ¸", "success");
                                }

                                async function runComplaintTicketSequence() {
                                    const br = document.getElementById('f-branch-master-sel').value;
                                    const ord = document.getElementById('f-order-id-input').value.trim();
                                    const cust = document.getElementById('f-customer-name-input').value.trim();
                                    const serviceType = document.getElementById('f-service-type-sel').value;
                                    const type = document.getElementById('f-complaint-type-sel').value;
                                    const msg = document.getElementById('f-complaint-msg-input').value.trim();
                                    if(!ord || !cust || !msg) { Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'warning'); return; }
                                    const timeNow = new Date().toLocaleTimeString('ar-EG');
                                    const selectedDate = document.getElementById('f-date-master').value;
                                    const ticketData = {
                                        branch: br, order: ord, customer: cust, service_type: serviceType, type: type, msg: msg,
                                        stage: 'dispatcher_review', status: 'active',
                                        timestamp: new Date().toLocaleString('ar-EG'), timeOnly: timeNow, date: selectedDate,
                                        author: currentUserSession.name,
                                        logs: [{ time: timeNow, user: currentUserSession.name, action: "Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„Ø§Øº" }]
                                    };
                                    await dbHub.ref('operations').push(ticketData);
                                    triggerBranchBroadcast(br, ord, cust, type, msg, timeNow);
                                    closeSidebarControl();
                                    renderSystemToast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„", "success");
                                    ['f-order-id-input','f-customer-name-input','f-complaint-msg-input'].forEach(id => document.getElementById(id).value = '');
                                }

                                async function triggerBranchBroadcast(br, ord, cust, type, msg, time) {
                                    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
                                    const instanceId = "instance157671";
                                    const token = "cpx85mx613v868fe";

                                    try {
                                        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                        const snap = await dbHub.ref(`settings/whatsapp_phones/${br}`).once('value');
                                        const phonesData = snap.val();

                                        if (!phonesData) {
                                            console.warn("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù…Ø³Ø¬Ù„Ø© Ù„Ù„ÙØ±Ø¹: " + br);
                                            return;
                                        }

                                        const pList = Object.values(phonesData);

                                        // Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ
                                        const text = `ğŸš¨ *Ø¨Ù„Ø§Øº CMS Ø¬Ø¯ÙŠØ¯* ğŸš¨\n\n` +
                                                     `ğŸ“ *Ø§Ù„ÙØ±Ø¹:* ${br}\n` +
                                                     `ğŸ”¢ *Ø§Ù„Ø·Ù„Ø¨:* ${ord}\n` +
                                                     `ğŸ‘¤ *Ø§Ù„Ø¹Ù…ÙŠÙ„:* ${cust}\n` +
                                                     `ğŸ·ï¸ *Ø§Ù„Ù†ÙˆØ¹:* ${type}\n` +
                                                     `ğŸ“ *Ø§Ù„ØªÙØ§ØµÙŠÙ„:* ${msg}\n` +
                                                     `â° *Ø§Ù„ÙˆÙ‚Øª:* ${time}\n\n` +
                                                     `ğŸ‘· *Ø§Ù„Ù…ÙˆØ¸Ù:* ${currentUserSession.name}`;

                                        pList.forEach(phone => {
                                            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù… ÙˆØªØ¬Ù‡ÙŠØ²Ù‡ Ù„Ù„ØµÙŠØºØ© Ø§Ù„Ø¯ÙˆÙ„ÙŠØ© (Ù…ØµØ± +20)
                                            let cleanPhone = phone.toString().replace(/\D/g, '');
                                            if (cleanPhone.startsWith('01')) {
                                                cleanPhone = '20' + cleanPhone.substring(1);
                                            } else if (!cleanPhone.startsWith('20')) {
                                                cleanPhone = '20' + cleanPhone;
                                            }

                                            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù€ UltraMsg
                                            fetch(`https://api.ultramsg.com/${instanceId}/messages/chat`, {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                                body: new URLSearchParams({
                                                    'token': token,
                                                    'to': cleanPhone,
                                                    'body': text
                                                })
                                            }).then(res => res.json()).then(data => {
                                                console.log("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰: " + cleanPhone, data);
                                            }).catch(err => console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨:", err));
                                        });

                                    } catch (error) {
                                        console.error("WhatsApp Broadcast Error:", error);
                                    }
                                }

function renderLiveBroadcastMatrix() {
    const box = document.getElementById('render-live-feed-matrix');
    box.innerHTML = "";

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
    const selectedBranch = document.getElementById('global-branch-filter').value;
    const isSuper = currentUserSession.role === 'SUPER';
    const isCallCenter = currentUserSession.title === 'ÙƒÙˆÙ„ Ø³Ù†ØªØ±';

    // Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};

    Object.keys(complaintsCache).reverse().forEach(id => {
        const op = complaintsCache[id];

        // 1. Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ© (done) ÙÙŠ Ø§Ù„Ø¨Ø« Ø§Ù„Ø­ÙŠ
        if(op.status === 'done') return;

        // 2. Ø´Ø±Ø· "Ø§Ù„Ø¹Ø²Ù„ Ø§Ù„Ù‚ÙˆÙŠ":
        // Ø§Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù† ÙˆØ§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± ÙŠØ´ÙÙˆÙ† ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ØŒ Ø£Ù…Ø§ Ù…ÙˆØ¸Ù Ø§Ù„ÙØ±Ø¹ ÙŠØ´ÙˆÙ ÙØ±Ø¹Ù‡ ÙÙ‚Ø·
        if (!isSuper && !isCallCenter && op.branch !== currentUserSession.branch) return;

        // 3. Ø´Ø±Ø· Ø§Ù„ÙÙ„ØªØ±Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± Ø§Ù„Ø³ÙˆØ¨Ø± ÙØ±Ø¹ Ù…Ø¹ÙŠÙ†)
        if (selectedBranch !== 'ALL' && op.branch !== selectedBranch) return;

        // 4. *** Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø£Ù‡Ù… (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙˆØ¨Ø±) ***
        // Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙŠØ®ØªÙÙŠ Ø§Ù„Ø¨Ù„Ø§Øº Ù…Ù† Ø¹Ù†Ø¯Ù‡ Ù„Ùˆ Ø±Ø¯ Ø¹Ù„ÙŠÙ‡ØŒ Ù„ÙƒÙ† Ø§Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù† "Ù„Ø§ ÙŠØ®ØªÙÙŠ" Ø£Ø¨Ø¯Ø§Ù‹
        const lastLog = op.logs && op.logs[op.logs.length - 1];
        const iAmLastResponder = lastLog && lastLog.user.includes(currentUserSession.name);

        if (iAmLastResponder && !isSuper && !isCallCenter) {
            return; // Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙŠØ®ØªÙÙŠ Ù…Ù† Ø¹Ù†Ø¯Ù‡ØŒ Ø§Ù„Ø³ÙˆØ¨Ø± ÙŠÙƒÙ…Ù„ ÙˆÙŠØ´ÙˆÙÙ‡
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù„Ø§Øº
        box.innerHTML += generateTicketMarkup(id, op, true, p);
    });

    if (box.innerHTML === "") {
        box.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: var(--text-muted-core);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
    }
}

                                function runArchiveRefreshSequence() {
                                    const box = document.getElementById('render-archive-grid-hub');
                                    if(!box) return;
                                    box.innerHTML = "";

                                    const from = document.getElementById('archive-date-from').value;
                                    const to = document.getElementById('archive-date-to').value;
                                    const selectedBranch = document.getElementById('global-branch-filter').value;

                                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                                    const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
                                    const isSuper = currentUserSession.role === 'SUPER';
                                    const isCallCenter = currentUserSession.title === 'ÙƒÙˆÙ„ Ø³Ù†ØªØ±';
                                    const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || isSuper || isCallCenter;

                                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ Ù„Ù…ØµÙÙˆÙØ© ÙˆØ¹Ø±Ø¶Ù‡Ø§ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
                                    Object.keys(complaintsCache).reverse().forEach(id => {
                                        const op = complaintsCache[id];

                                        // Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙŠØ¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„ØªÙŠ Ø­Ø§Ù„ØªÙ‡Ø§ 'done'
                                        if(op.status !== 'done') return;

                                        // ÙÙ„ØªØ±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (ÙƒÙ„ ÙØ±Ø¹ ÙŠØ±Ù‰ Ø¨Ù„Ø§ØºØ§ØªÙ‡ ÙÙ‚Ø· Ø¥Ù„Ø§ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)
                                        if(!canSeeAll && op.branch !== currentUserSession.branch) return;

                                        // ÙÙ„ØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
                                        if(from && op.date < from) return;
                                        if(to && op.date > to) return;

                                        // ÙÙ„ØªØ±Ø© Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
                                        if(selectedBranch !== 'ALL' && op.branch !== selectedBranch) return;

                                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù„Ø§Øº Ù„Ù„Ù…ØµÙÙˆÙØ© (Ù…Ø¹ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ø£Ù†Ù‡ Ù…Ø¤Ø±Ø´Ù)
                                        box.innerHTML += generateTicketMarkup(id, op, false, p);
                                    });

                                    if (box.innerHTML === "") {
                                        box.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: var(--text-muted-core);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ù…Ø¤Ø±Ø´ÙØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</div>`;
                                    }
                                }

                                // === UPDATED TICKET MARKUP FOR HOVER REVEAL ===
function generateTicketMarkup(id, op, isInteractive, p) {
    let btns = "";
    const userTitle = currentUserSession.title;
    const isSuper = currentUserSession.role === 'SUPER';

    if(isInteractive) {
        // Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: "ØªÙ…Ø§Ù…" Ø§Ù„Ø°ÙŠ ÙŠØ¤Ø±Ø´Ù Ù…Ø¨Ø§Ø´Ø±Ø©
        btns += `<button class="btn-vip-execute-master" style="background:#4ebf57; color:#000; margin-bottom:10px; font-size:1.2rem;" onclick="event.stopPropagation(); quickArchiveTicket('${id}')">ØªÙ…Ø§Ù…</button>`;

        // Ù…Ù†Ø·Ù‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (Ø§Ù„Ø¢Ù† Ø§Ù„Ø³ÙˆØ¨Ø± ÙŠØ±Ù‰ Ø§Ù„ÙƒÙ„ØŒ ÙˆØ§Ù„Ù…ÙˆØ¸Ù ÙŠØ±Ù‰ Ù…Ø±Ø­Ù„ØªÙ‡)
        
        // 1. Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯ÙŠØ³Ø¨ØªØ´Ø±
        if((op.stage === 'dispatcher_review' || isSuper)) {
            btns += `<button class="btn-vip-execute-master" style="background:var(--success-glow); color:#000; margin-bottom:5px;" onclick="event.stopPropagation(); processWorkflowStep('${id}', 'waiting_review', 'Ø±Ø¯ Ø§Ù„Ø¯ÙŠØ³Ø¨ØªØ´Ø±')">Ø±Ø¯ Ø§Ù„Ø¯ÙŠØ³Ø¨ØªØ´Ø±</button>`;
        }

        // 2. Ù…Ø±Ø­Ù„Ø© Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹
        if((op.stage === 'waiting_review' || isSuper)) {
            btns += `<button class="btn-vip-execute-master" style="background:#8b5cf6; margin-bottom:5px;" onclick="event.stopPropagation(); processWorkflowStep('${id}', 'branch_reply', 'Ø±Ø¯ Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹')">Ø±Ø¯ Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹</button>`;
        }

        // 3. Ù…Ø±Ø­Ù„Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
        if((op.stage === 'branch_reply' || isSuper)) {
            btns += `<button class="btn-vip-execute-master" style="background:#f59e0b; margin-bottom:5px;" onclick="event.stopPropagation(); processWorkflowStep('${id}', 'regional_review', 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©')">Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</button>`;
        }

        // 4. Ù…Ø±Ø­Ù„Ø© Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ´ØºÙŠÙ„
        if((op.stage === 'regional_review' || isSuper)) {
            btns += `<button class="btn-vip-execute-master" style="background:#10b981; color:#000; margin-bottom:5px;" onclick="event.stopPropagation(); processWorkflowStep('${id}', 'ops_final', 'Ù‚Ø±Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ´ØºÙŠÙ„')">Ù‚Ø±Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ´ØºÙŠÙ„</button>`;
        }

        // 5. Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ±
        if((op.stage === 'ops_final' || isSuper)) {
            btns += `<button class="btn-vip-execute-master" style="background:#1d4ed8; margin-bottom:5px;" onclick="event.stopPropagation(); finalizeTicketAndArchive('${id}')">Ø¥ØºÙ„Ø§Ù‚ ÙˆØ£Ø±Ø´ÙØ© Ù†Ù‡Ø§Ø¦ÙŠØ©</button>`;
        }
    }

    // Ø²Ø± Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø³ÙˆØ¨Ø± Ø£Ùˆ Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ±
    if(isSuper || userTitle === 'ÙƒÙˆÙ„ Ø³Ù†ØªØ±') {
        btns += `<button class="btn-vip-execute-master" style="background:var(--danger-pulse); margin-top:10px;" onclick="event.stopPropagation(); deleteTicketRecord('${id}')">Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>`;
    }

    const logs = op.logs ? op.logs.map(l => `<div style="font-size:0.85rem; color:#e0e0e0; border-bottom:1px solid #333; padding:5px 0;">â–ªï¸ <b>${l.user}</b>: ${l.action} <span style="font-size:0.7rem; color:#888;">(${l.time})</span></div>`).join('') : '';

    return `
        <div class="massive-glass-card ticket-visual-unit" onclick="this.classList.toggle('is-fixed')">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <b style="color:var(--gold-master); font-size:1.1rem;">ğŸ“ ${op.branch}</b>
                    <div style="font-size:0.75rem; color:#8b949e;">${op.date} | ${op.timeOnly}</div>
                    <div style="color:#fff; font-size:0.8rem; margin-top:5px; background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:4px; display:inline-block;">
                        Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${getStageNameAr(op.stage)}
                    </div>
                </div>
                <div style="text-align:left;">
                    <span style="color:var(--gold-master); font-size:0.8rem;">Ø£ÙˆØ±Ø¯Ø± #</span>
                    <div class="order-number-badge">${op.order}</div>
                </div>
            </div>

            <div class="ticket-hidden-details">
                <div style="margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <div style="margin-bottom:5px;">ğŸ‘¤ <b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${op.customer}</div>
                    <div style="margin-bottom:5px; color:#ff6b6b;">ğŸ·ï¸ <b>Ø§Ù„Ù†ÙˆØ¹:</b> ${op.type}</div>
                    <div style="color:#4ebf57;">ğŸ“ <b>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</b> ${op.msg}</div>
                </div>
                <div style="background:rgba(0,0,0,0.4); padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #222;">
                    <div style="color:var(--gold-master); font-weight:bold; margin-bottom:8px; border-bottom:1px solid #444;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª:</div>
                    ${logs}
                </div>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    ${btns}
                </div>
            </div>
        </div>`;
}

                                // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ±Ø¬Ù…Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©
                                function getStageNameAr(stage) {
                                    const stages = {
                                        'dispatcher_review': 'Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙŠØ³Ø¨ØªØ´Ø±',
                                        'waiting_review': 'Ø¹Ù†Ø¯ Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹',
                                        'branch_reply': 'Ø¹Ù†Ø¯ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',
                                        'regional_review': 'Ø¹Ù†Ø¯ Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ´ØºÙŠÙ„',
                                        'ops_final': 'Ø¹Ù†Ø¯ Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± (Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©)',
                                        'closed': 'Ù…Ø¤Ø±Ø´Ù'
                                    };
                                    return stages[stage] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                                }

                                async function processWorkflowStep(id, nextStage, actionLabel) {
                                    const { value: comment } = await Swal.fire({
                                        title: actionLabel,
                                        input: 'textarea',
                                        inputLabel: 'Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø£Ùˆ Ø±Ø¯Ùƒ Ù‡Ù†Ø§',
                                        inputPlaceholder: 'Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...',
                                        showCancelButton: true,
                                        confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©',
                                        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                                    });

                                    if (comment !== undefined) {
                                        const op = complaintsCache[id];
                                        const newLog = {
                                            time: new Date().toLocaleTimeString('ar-EG'),
                                            user: currentUserSession.name + " (" + currentUserSession.title + ")",
                                            action: actionLabel + ": " + (comment || "ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©")
                                        };

                                        await dbHub.ref('operations/' + id).update({
                                            stage: nextStage,
                                            logs: [...(op.logs || []), newLog]
                                        });

                                        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø¯ÙŠØ³Ø¨ØªØ´Ø±
                                        if (actionLabel === 'Ø±Ø¯ Ø§Ù„Ø¯ÙŠØ³Ø¨ØªØ´Ø±') {
                                            const replyMsg = comment || "ØªÙ… Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø¯ÙŠØ³Ø¨ØªØ´Ø±: ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©";
                                            triggerBranchBroadcast(op.branch, op.order, op.customer, 'Ø±Ø¯ Ù…Ù† Ø§Ù„Ø¯ÙŠØ³Ø¨ØªØ´Ø±', replyMsg, new Date().toLocaleTimeString('ar-EG'));
                                        }

                                        renderSystemToast("ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©", "success");
                                    }
                                }

                                async function executeAdvancedAnalyticsSequence() {
                                    const from = document.getElementById('reports-date-from').value;
                                    const to = document.getElementById('reports-date-to').value;
                                    const isSuper = currentUserSession.role === 'SUPER';
                                    const isCallCenter = currentUserSession.title === 'ÙƒÙˆÙ„ Ø³Ù†ØªØ±';
                                    const selectedBranch = document.getElementById('reports-branch-filter').value;

                                    if (!from || !to) {
                                        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                                        return;
                                    }

                                    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                                    renderSystemToast("Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", "success");
                                    const dSnap = await dbHub.ref('daily_stats').get();
                                    const allDays = dSnap.val() || {};

                                    let ops = Object.values(complaintsCache).filter(o => {
                                        const matchDate = o.date >= from && o.date <= to;

                                        // Ù„Ùˆ Ø§Ø®ØªØ§Ø± ÙØ±Ø¹ Ù…Ø¹ÙŠÙ† ÙÙ„ØªØ± Ø¹Ù„ÙŠÙ‡ØŒ Ù„Ùˆ ALL ÙŠØ¨Ù‚Ù‰ Ù‡Ø§Øª Ø§Ù„ÙƒÙ„ (Ù„Ùˆ Ù…Ø¹Ø§Ù‡ ØµÙ„Ø§Ø­ÙŠØ©)
                                        const matchBranch = (selectedBranch === "ALL") ? true : (o.branch === selectedBranch);

                                        return matchDate && matchBranch;
                                    });

                                    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (Stats)
                                    updateTopStatCards(ops, allDays, from, to, selectedBranch);

                                    // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
                                    updateAnalyticsCharts(ops, selectedBranch, allDays, from, to);

                                    // 4. Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (Ù…Ø«Ù„ Ø§Ù„Ø¥ÙƒØ³Ù„)
                                    populateDetailedComplaintsTable(ops);

                                    // 5. Ù…Ù„Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
                                    populateEfficiencyTable(ops, allDays, from, to);
                                }

                                function updateTopStatCards(ops, allDays, from, to, selectedBranch) {
                                    let totalOrdersPeriod = 0;
                                    Object.keys(allDays).forEach(day => {
                                        if (day >= from && day <= to) {
                                            Object.keys(allDays[day]).forEach(br => {
                                                if (selectedBranch === "ALL" || br === selectedBranch) {
                                                    totalOrdersPeriod += parseInt(allDays[day][br] || 0);
                                                }
                                            });
                                        }
                                    });

                                    let totalComplaints = ops.length;
                                    let resolved = ops.filter(o => o.status === 'done').length;
                                    let errorRate = totalOrdersPeriod > 0 ? ((totalComplaints / totalOrdersPeriod) * 100).toFixed(2) : 0;
                                    let completionRate = totalComplaints > 0 ? Math.round((resolved / totalComplaints) * 100) : 0;

                                    document.getElementById('render-analytics-stat-row').innerHTML = `
                                        <div class="analytics-pill-card" style="border-top:12px solid #8b5cf6">
                                            <h2>${totalOrdersPeriod.toLocaleString()}</h2>
                                            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</p>
                                        </div>
                                        <div class="analytics-pill-card" style="border-top:12px solid var(--gold-master)">
                                            <h2>${totalComplaints}</h2>
                                            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</p>
                                        </div>
                                        <div class="analytics-pill-card" style="border-top:12px solid #ef4444">
                                            <h2>${errorRate}%</h2>
                                            <p>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø¹Ø§Ù…</p>
                                        </div>
                                        <div class="analytics-pill-card" style="border-top:12px solid var(--success-glow)">
                                            <h2>${resolved}</h2>
                                            <p>Ø´ÙƒØ§ÙˆÙ‰ Ù…ØºÙ„Ù‚Ø©</p>
                                        </div>
                                        <div class="analytics-pill-card" style="border-top:12px solid var(--accent-navy)">
                                            <h2>${completionRate}%</h2>
                                            <p>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</p>
                                        </div>
                                    `;
                                }

                                function updateAnalyticsCharts(ops, selectedBranch, allDays, from, to) {
                                    // 6. Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (Ù†Ø³Ø¨Ø© Ø§Ù„Ø®Ø·Ø£ Ù„ÙƒÙ„ ÙØ±Ø¹ Ø¹Ù„Ù‰ Ø­Ø¯Ø©)
                                    const labels = [];
                                    const branchRates = [];

                                    const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
                                    const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';

                                    branchListCache.forEach(br => {
                                        if(!canSeeAll && br !== currentUserSession.branch) return;

                                        labels.push(br);
                                        const brComplaints = ops.filter(o => o.branch === br).length;
                                        let brOrders = 0;

                                        Object.keys(allDays).forEach(day => {
                                            if(day >= from && day <= to && allDays[day][br]) {
                                                brOrders += parseInt(allDays[day][br]);
                                            }
                                        });

                                        // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®Ø·Ø£ Ù„ÙƒÙ„ ÙØ±Ø¹
                                        let rate = brOrders > 0 ? ((brComplaints / brOrders) * 100).toFixed(2) : 0;
                                        branchRates.push(rate);
                                    });

                                    // 7. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©)
                                    if(analyticsChartInstance) analyticsChartInstance.destroy();
                                    analyticsChartInstance = new Chart(document.getElementById('master-reports-canvas').getContext('2d'), {
                                        type: 'bar',
                                        plugins: [ChartDataLabels],
                                        data: {
                                            labels: labels,
                                            datasets: [{
                                                label: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£ % (Ø´ÙƒØ§ÙˆÙ‰/Ø£ÙˆØ±Ø¯Ø±Ø§Øª)',
                                                data: branchRates,
                                                backgroundColor: '#f59e0b',
                                                borderRadius: 8
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            scales: {
                                                y: { beginAtZero: true, ticks: { color: '#fff' }, title: {display:true, text:'Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© %', color:'#fff'} },
                                                x: { ticks: { color: '#fff' } }
                                            },
                                            plugins: {
                                                legend: { labels: { color: '#fff' } },
                                                datalabels: {
                                                    color: '#fff',
                                                    anchor: 'end',
                                                    align: 'top',
                                                    formatter: (v) => v + '%'
                                                }
                                            }
                                        }
                                    });

                                    // 8. ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø·Ø· Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ (Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©)
                                    const typeCounts = {};
                                    ops.forEach(o => { typeCounts[o.type || 'Ø£Ø®Ø±Ù‰'] = (typeCounts[o.type || 'Ø£Ø®Ø±Ù‰'] || 0) + 1; });

                                    if(analyticsTypeChartInstance) analyticsTypeChartInstance.destroy();
                                    analyticsTypeChartInstance = new Chart(document.getElementById('master-types-canvas').getContext('2d'), {
                                        type: 'doughnut',
                                        plugins: [ChartDataLabels],
                                        data: {
                                            labels: Object.keys(typeCounts),
                                            datasets: [{
                                                data: Object.values(typeCounts),
                                                backgroundColor: ['#f59e0b','#ef4444','#10b981','#1d4ed8','#8b5cf6'],
                                                borderWidth: 0
                                            }]
                                        },
                                        options: {
                                            plugins: {
                                                legend: { position: 'bottom', labels: { color: '#fff' } },
                                                datalabels: { color: '#000', backgroundColor: '#fff', borderRadius: 4, font: {weight:'bold'} }
                                            }
                                        }
                                    });
                                }

                                async function exportReportsToExcel() {
                                    const from = document.getElementById('reports-date-from').value;
                                    const to = document.getElementById('reports-date-to').value;
                                    const selectedBranch = document.getElementById('reports-branch-filter').value;

                                    if (!from || !to) {
                                        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØªØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                                        return;
                                    }

                                    renderSystemToast("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø§Ù„Ù…Ù„ÙˆÙ†...", "success");

                                    const workbook = new ExcelJS.Workbook();
                                    const worksheet = workbook.addWorksheet('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ø§Ù„Ø´Ø§Ù…Ù„', {
                                        views: [{ rightToLeft: true }] // Ø¶Ø¨Ø· Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±
                                    });

                                    // --- ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
                                    const dSnap = await dbHub.ref('daily_stats').get();
                                    const allDays = dSnap.val() || {};
                                    const ops = Object.values(complaintsCache).filter(o => {
                                        const matchDate = o.date >= from && o.date <= to;
                                        const matchBranch = (selectedBranch === "ALL") ? true : (o.branch === selectedBranch);
                                        return matchDate && matchBranch;
                                    });

                                    const categories = ["ØªØ£Ø®ÙŠØ±", "Ø³ÙˆØ¡ Ø®Ø¯Ù…Ø©", "Ù†Ø§Ù‚Øµ", "Ø³ÙˆØ¡ ØªØ¹Ø¨Ø¦Ø©", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ", "Ø¬ÙˆØ¯Ø©", "Ø¬Ø³Ù… ØºØ±ÙŠØ¨", "Ø³ÙˆØ¡ Ø³Ù„ÙˆÙƒ", "Ù…Ù†Ø¯ÙˆØ¨", "Ø·Ù„Ø¨ Ø¨Ø§Ø±Ø¯", "Ø±Ø³ÙŠØ¨ÙŠ", "ØªØ£Ø®ÙŠØ± Ø´ÙƒÙˆÙ‰", "ØªÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„ÙØ±Ø¹", "Ø³ÙˆØ´ÙŠØ§Ù„"];
                                    const serviceTypes = ["HD", "Din In", "PK", "TA"];

                                    // --- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„: ØªØ­Ù„ÙŠÙ„ Ø´ÙƒØ§ÙˆÙ‰ Ø§Ù„Ù…Ø·Ø§Ø¹Ù… ---
                                    worksheet.mergeCells('A1:U1');
                                    const mainTitle = worksheet.getCell('A1');
                                    mainTitle.value = 'ØªØ­Ù„ÙŠÙ„ Ø´ÙƒØ§ÙˆÙ‰ Ø§Ù„Ù…Ø·Ø§Ø¹Ù… Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„';
                                    mainTitle.font = { bold: true, size: 16, color: { argb: 'FFFFFFFF' } };
                                    mainTitle.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1D4ED8' } };
                                    mainTitle.alignment = { horizontal: 'center' };

                                    // Ø§Ù„Ø±Ø£Ø³ (Headers)
                                    const headerRow = ["Ø§Ù„Ù…Ø·Ø¹Ù…", ...categories, ...serviceTypes, "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ø¹Ù…"];
                                    const headerRowCells = worksheet.addRow(headerRow);
                                    headerRowCells.eachCell((cell, colNumber) => {
                                        cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1D4ED8' } }; // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚
                                        cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                                        cell.alignment = { horizontal: 'center' };
                                    });

                                    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                    let grandTotals = { total: 0 };
                                    categories.forEach(c => grandTotals[c] = 0);
                                    serviceTypes.forEach(s => grandTotals[s] = 0);

                                    const isSuper = currentUserSession.role === 'SUPER' || currentUserSession.branch === 'ALL';

                                    branchListCache.forEach(branch => {
                                        // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±Ø· Ù‡Ù†Ø§: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø³ÙˆØ¨Ø± ÙŠÙ…Ø±Ø± Ø§Ù„ÙƒÙ„ØŒ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¸Ù ÙŠÙ…Ø±Ø± ÙØ±Ø¹Ù‡ ÙÙ‚Ø·
                                        if (!isSuper && branch !== currentUserSession.branch) return;

                                        const branchOps = ops.filter(o => o.branch === branch);
                                        if (branchOps.length === 0) return;

                                        let rowData = [branch];
                                        let branchSum = 0;
                                        categories.forEach(cat => {
                                            const count = branchOps.filter(o => o.type === cat).length;
                                            rowData.push(count);
                                            grandTotals[cat] += count;
                                            branchSum += count;
                                        });
                                        serviceTypes.forEach(srv => {
                                            const count = branchOps.filter(o => o.service_type === srv).length;
                                            rowData.push(count);
                                            grandTotals[srv] += count;
                                        });
                                        rowData.push(branchSum);
                                        grandTotals.total += branchSum;

                                        const addedRow = worksheet.addRow(rowData);
                                        addedRow.getCell(addedRow.cellCount).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF59E0B' } }; // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                                        addedRow.eachCell(cell => {
                                            cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                                            cell.alignment = { horizontal: 'center' };
                                        });
                                    });

                                    // Ø³Ø·Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù…
                                    const footerData = ["Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰ Ø§Ù„Ø¹Ø§Ù…", ...categories.map(c => grandTotals[c]), ...serviceTypes.map(s => grandTotals[s]), grandTotals.total];
                                    const footerRow = worksheet.addRow(footerData);
                                    footerRow.eachCell(cell => {
                                        cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0A2E91' } }; // ÙƒØ­Ù„ÙŠ ØºØ§Ù…Ù‚
                                        cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                                        cell.alignment = { horizontal: 'center' };
                                    });

                                    // --- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù†Ø³Ø¨Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ---
                                    worksheet.addRow([]); // Ø³Ø·Ø± ÙØ§Ø±Øº
                                    worksheet.addRow(["Ù†Ø³Ø¨Ø© Ø´ÙƒØ§ÙˆÙ‰ Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù„ÙØ±ÙˆØ¹"]).font = { bold: true, size: 14 };
                                    const effHeader = worksheet.addRow(["Ø§Ù„Ù…Ø·Ø¹Ù…", "Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰", "Ø§Ù„Ù†Ø³Ø¨Ø©"]);
                                    effHeader.eachCell(cell => {
                                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF333333' } };
                                        cell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
                                    });

                                    branchListCache.forEach(branch => {
                                        let orders = 0;
                                        Object.keys(allDays).forEach(d => { if(d >= from && d <= to) orders += parseInt(allDays[d][branch] || 0); });
                                        const complaints = ops.filter(o => o.branch === branch).length;
                                        if(orders > 0 || complaints > 0) {
                                            const r = worksheet.addRow([branch, orders, complaints, (orders > 0 ? ((complaints / orders) * 100).toFixed(2) : 0) + "%"]);
                                            r.alignment = { horizontal: 'center' };
                                        }
                                    });

                                    // --- Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ÙƒØµÙˆØ±Ø© (Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„ÙˆØ¶ÙˆØ­ Ø§Ù„ØªØ§Ù…) ---
                                    const canvas = document.getElementById('master-reports-canvas');
                                    if (canvas && analyticsChartInstance) {
                                        // 1. Ø­ÙØ¸ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡)
                                        const oldXColor = analyticsChartInstance.options.scales.x.ticks.color;
                                        const oldYColor = analyticsChartInstance.options.scales.y.ticks.color;
                                        const oldDataColor = analyticsChartInstance.options.plugins.datalabels.color;
                                        const oldXFont = analyticsChartInstance.options.scales.x.ticks.font;

                                        // 2. ØªØ­ÙˆÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ù„Ø£Ø³ÙˆØ¯ ÙˆØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ù„Ù„ÙˆØ¶ÙˆØ­ ÙÙŠ Ø§Ù„Ø¥ÙƒØ³Ù„
                                        analyticsChartInstance.options.scales.x.ticks.color = '#000000';
                                        analyticsChartInstance.options.scales.y.ticks.color = '#000000';
                                        analyticsChartInstance.options.plugins.datalabels.color = '#000000';

                                        // ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ±ÙˆØ¹ (Ø±ÙˆÙƒØ³ÙŠØŒ ÙÙŠØµÙ„...)
                                        analyticsChartInstance.options.scales.x.ticks.font = { size: 16, weight: 'bold' };
                                        analyticsChartInstance.options.scales.y.ticks.font = { size: 14 };

                                        // Ø¥Ø¸Ù‡Ø§Ø± Ø®Ø·ÙˆØ· Ø§Ù„Ø´Ø¨ÙƒØ© Ø¨Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ ÙˆØ§Ø¶Ø­ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø§Ø®ØªÙØ§Ø¡
                                        analyticsChartInstance.options.scales.x.grid = { color: '#cccccc' };
                                        analyticsChartInstance.options.scales.y.grid = { color: '#cccccc' };

                                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… ÙÙˆØ±Ø§Ù‹ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡
                                        analyticsChartInstance.update(0);

                                        // 3. Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©
                                        const chartImage = canvas.toDataURL('image/png', 1.0);
                                        const imageId = workbook.addImage({
                                            base64: chartImage,
                                            extension: 'png',
                                        });

                                        // 4. Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…ÙˆÙ‚Ø¹ (Ø¹Ø´Ø§Ù† ÙŠØ±Ø¬Ø¹ Ø£Ø¨ÙŠØ¶ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ)
                                        analyticsChartInstance.options.scales.x.ticks.color = oldXColor;
                                        analyticsChartInstance.options.scales.y.ticks.color = oldYColor;
                                        analyticsChartInstance.options.plugins.datalabels.color = oldDataColor;
                                        analyticsChartInstance.options.scales.x.ticks.font = oldXFont;
                                        analyticsChartInstance.options.scales.x.grid = { color: '#333' }; // Ø±Ø¬ÙˆØ¹ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„ØºØ§Ù…Ù‚
                                        analyticsChartInstance.options.scales.y.grid = { color: '#333' };

                                        analyticsChartInstance.update(0);

                                        // 5. ÙˆØ¶Ø¹ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø¥ÙƒØ³Ù„ (Ø¨Ù…Ø³Ø§Ø­Ø© Ø£ÙƒØ¨Ø±)
                                        // tl: rowCount + 2 (ØªØ­Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨ØµÙÙŠÙ†)
                                        worksheet.addImage(imageId, {
                                            tl: { col: 0, row: worksheet.rowCount + 2 },
                                            ext: { width: 900, height: 450 } // Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± ÙˆÙˆØ§Ø¶Ø­
                                        });
                                    }

                                    // --- Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ---
                                    const buffer = await workbook.xlsx.writeBuffer();
                                    saveAs(new Blob([buffer]), `ØªÙ‚Ø±ÙŠØ±_CMS_Ø´Ø§Ù…Ù„_${from}.xlsx`);
                                }

                                // Ticket Action Modals
                                async function openBranchReplyModalHub(id) {
                                    const {value:r} = await Swal.fire({ title:'Ø±Ø¯ Ø§Ù„ÙØ±Ø¹', html:`<select id="s1" class="swal2-input"><option value="ÙƒØ§Ù…Ù„">âœ… Ø³Ù„ÙŠÙ…</option><option value="Ù†Ø§Ù‚Øµ">âŒ Ù†Ø§Ù‚Øµ ÙØ¹Ù„Ø§Ù‹</option></select><textarea id="s2" class="swal2-input" placeholder="Ø§Ù„ØªÙØ§ØµÙŠÙ„"></textarea>`, preConfirm:()=>[document.getElementById('s1').value,document.getElementById('s2').value] });
                                    if(r) {
                                        const op = complaintsCache[id], log={time:new Date().toLocaleTimeString('ar-EG'),user:currentUserSession.name,action:r[0]==='Ù†Ø§Ù‚Øµ'?'Ø§Ø¹ØªØ±Ø§Ù Ø¨Ø§Ù„Ù†Ù‚Øµ':'Ø§Ù„Ø·Ù„Ø¨ Ø³Ù„ÙŠÙ…'};
                                        await dbHub.ref('operations/'+id).update({ stage:'replied', branch_verdict:r[0], dispatcher_name:currentUserSession.name, logs:[...(op.logs||[]),log], status:r[0]==='Ù†Ø§Ù‚Øµ'?'done':'active' });
                                        renderSystemToast("ØªÙ… Ø§Ù„Ø±Ø¯", "success");
                                    }
                                }
                                async function quickArchiveTicket(id) {
                                    const op = complaintsCache[id];
                                    const log = {
                                        time: new Date().toLocaleTimeString('ar-EG'),
                                        user: currentUserSession.name,
                                        action: "ØªÙ… Ø§Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©"
                                    };
                                    await dbHub.ref('operations/' + id).update({
                                        status: 'done',
                                        logs: [...(op.logs || []), log]
                                    });
                                    renderSystemToast("ØªÙ… Ø§Ù„Ø£Ø±Ø´ÙØ© Ø¨Ù†Ø¬Ø§Ø­", "success");
                                }

                                async function finalizeTicketAndArchive(id) {
                                    const op = complaintsCache[id];
                                    const finalLog = {
                                        time: new Date().toLocaleTimeString('ar-EG'),
                                        user: currentUserSession.name + " (ÙƒÙˆÙ„ Ø³Ù†ØªØ±)",
                                        action: "ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©"
                                    };

                                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ²
                                    await dbHub.ref('operations/' + id).update({
                                        status: 'done', // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ù‡Ù… Ù„ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                                        stage: 'closed',
                                        logs: [...(op.logs || []), finalLog]
                                    });

                                    renderSystemToast("ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ù„Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­", "success");
                                }
                                async function sendToBranchManagerFromCallCenter(id) { await dbHub.ref('operations/'+id).update({stage:'sent_to_branch_manager', logs:[...(complaintsCache[id].logs||[]),{time:new Date().toLocaleTimeString('ar-EG'),user:currentUserSession.name,action:"Ø¥Ø±Ø³Ø§Ù„ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹"}]}); renderSystemToast("ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„","success"); }
                                async function sendToRegionalManager(id) { await dbHub.ref('operations/'+id).update({stage:'sent_to_regional_manager', logs:[...(complaintsCache[id].logs||[]),{time:new Date().toLocaleTimeString('ar-EG'),user:currentUserSession.name,action:"Ø¥Ø±Ø³Ø§Ù„ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©"}]}); renderSystemToast("ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„","success"); }
                                async function deleteTicketRecord(id) { if((await Swal.fire({title:'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ',icon:'warning',showCancelButton:true})).isConfirmed) { await dbHub.ref('operations/'+id).remove(); renderSystemToast("ØªÙ… Ø§Ù„Ø­Ø°Ù","success"); } }
                                async function openBranchManagerReplyModalHub(id) {
                                    const {value:r} = await Swal.fire({ title:'Ø±Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±', html:`<select id="s1" class="swal2-input"><option value="ÙƒØ§Ù…Ù„">âœ… Ø³Ù„ÙŠÙ…</option><option value="Ù†Ø§Ù‚Øµ">âŒ Ù†Ø§Ù‚Øµ ÙØ¹Ù„Ø§Ù‹</option></select><textarea id="s2" class="swal2-input"></textarea>`, preConfirm:()=>[document.getElementById('s1').value,document.getElementById('s2').value] });
                                    if(r) { await dbHub.ref('operations/'+id).update({stage:'sent_back_to_call_center', branch_manager_verdict:r[0], branch_manager_name:currentUserSession.name, logs:[...(complaintsCache[id].logs||[]),{time:new Date().toLocaleTimeString('ar-EG'),user:currentUserSession.name,action:'Ø±Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±: '+r[0]}]}); renderSystemToast("ØªÙ… Ø§Ù„Ø±Ø¯","success"); }
                                }
                                async function openRegionalManagerReplyModalHub(id) {
                                    const {value:r} = await Swal.fire({ title:'Ø±Ø¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', html:`<select id="s1" class="swal2-input"><option value="ÙƒØ§Ù…Ù„">âœ… Ø³Ù„ÙŠÙ…</option><option value="Ù†Ø§Ù‚Øµ">âŒ Ù†Ø§Ù‚Øµ ÙØ¹Ù„Ø§Ù‹</option></select><textarea id="s2" class="swal2-input"></textarea>`, preConfirm:()=>[document.getElementById('s1').value,document.getElementById('s2').value] });
                                    if(r) { await dbHub.ref('operations/'+id).update({stage:'sent_to_regional_manager', regional_manager_verdict:r[0], regional_manager_name:currentUserSession.name, logs:[...(complaintsCache[id].logs||[]),{time:new Date().toLocaleTimeString('ar-EG'),user:currentUserSession.name,action:'Ø±Ø¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: '+r[0]}]}); renderSystemToast("ØªÙ… Ø§Ù„Ø±Ø¯","success"); }
                                }

                                // ÙˆØ¸ÙŠÙØ© Ø­Ø°Ù Ù…ÙˆØ¸Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ (Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…Ù† Ø§Ù„Ø±Ø§Ø¯Ø§Ø±)
                                async function deleteUserEntirely(uid, userName) {
                                    if (currentUserSession.role !== 'SUPER') return; // Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©

                                    const result = await Swal.fire({
                                        title: `Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù: ${userName}ØŸ`,
                                        text: "Ø³ÙŠØ®ØªÙÙŠ Ù…Ù† Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙˆÙ…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.",
                                        icon: 'warning',
                                        showCancelButton: true,
                                        confirmButtonColor: '#ef4444',
                                        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø­Ø°Ù',
                                        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                                    });

                                    if (result.isConfirmed) {
                                        // 1. Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                                        await dbHub.ref('users/' + uid).remove();
                                        // 2. Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø±Ø§Ø¯Ø§Ø± (Ø¹Ø´Ø§Ù† ÙŠØ®ØªÙÙŠ undefined Ø£Ùˆ Ø£ÙŠ Ø¯Ø§ØªØ§ Ù‚Ø¯ÙŠÙ…Ø©)
                                        await dbHub.ref('users_presence/' + uid).remove();

                                        renderSystemToast("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­", "success");
                                        renderAdminUsersScrollBox(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
                                    }
                                }

                                // Ø­Ø°Ù Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„
                                async function deleteSpecificLog(logId) {
                                    if (currentUserSession.role !== 'SUPER') return;
                                    await dbHub.ref('access_logs/' + logId).remove();
                                    renderSystemToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„", "success");
                                }

                                // Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ù„Ù„Ø³ÙˆØ¨Ø± ÙÙ‚Ø·)
                                async function clearAllSystemLogs() {
                                    if (currentUserSession.role !== 'SUPER') return;

                                    const result = await Swal.fire({
                                        title: 'Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŸ',
                                        text: "Ù‡Ø°Ø§ Ø§Ù„ÙØ¹Ù„ Ø³ÙŠÙ…Ø³Ø­ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!",
                                        icon: 'danger',
                                        showCancelButton: true,
                                        confirmButtonColor: '#ef4444',
                                        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„'
                                    });

                                    if (result.isConfirmed) {
                                        await dbHub.ref('access_logs').remove();
                                        renderSystemToast("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­", "success");
                                    }
                                }

                                // Admin Utilities
                                function syncUiDropdownSelections() {
                                    const branchesObj = systemSettingsCache.branches || {};
                                    const branchesArray = Object.values(branchesObj);
                                    branchListCache = branchesArray;

                                    const isSuper = currentUserSession.role === 'SUPER';
                                    const isCallCenter = currentUserSession.title === 'ÙƒÙˆÙ„ Ø³Ù†ØªØ±';
                                    const userBranch = currentUserSession.branch;

                                    // --- ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙˆØ¹ ---
                                    let branchesHtml = "";
                                    if (isSuper || isCallCenter) {
                                        branchesHtml = `<option value="ALL">-- Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ --</option>` +
                                                      branchesArray.map(b => `<option value="${b}">${b}</option>`).join('');
                                    } else {
                                        branchesHtml = `<option value="${userBranch}">${userBranch}</option>`;
                                    }

                                    const selectors = [
                                        'global-branch-filter', 'reports-branch-filter',
                                        'log-filter-branch', 'radar-branch-filter-select',
                                        'f-branch-master-sel', 'adm-whatsapp-br-sel', 'reg-user-branch-sel-core'
                                    ];

                                    selectors.forEach(id => {
                                        const el = document.getElementById(id);
                                        if (el) {
                                            el.innerHTML = branchesHtml;
                                            if (!isSuper && !isCallCenter) {
                                                el.value = userBranch;
                                                el.disabled = true;
                                            }
                                        }
                                    });

                                    // --- ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±ØªØ¨ (Ø­Ù„ Ù…Ø´ÙƒÙ„ØªÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©) ---
                                    const ranksObj = systemSettingsCache.custom_ranks || {};
                                    const ranksHtml = Object.keys(ranksObj).map(r => `<option value="${r}">${r}</option>`).join('');
                                    
                                    ['adm-rank-matrix-sel', 'reg-user-rank-sel-core'].forEach(id => {
                                        const el = document.getElementById(id);
                                        if (el) {
                                            el.innerHTML = ranksHtml;
                                        }
                                    });
                                    console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØªØ¨ ÙˆØ§Ù„ÙØ±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­");
                                }

                                // 2. ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ù„ØªØ¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ©
                                function syncUiDropdownSelections() {
                                    // Ø¬Ù„Ø¨ Ø§Ù„ÙØ±ÙˆØ¹ Ù…Ù† Ø§Ù„ÙƒØ§Ø´
                                    const branchesObj = systemSettingsCache.branches || {};
                                    const branchesArray = Object.values(branchesObj);
                                    branchListCache = branchesArray;

                                    const isSuper = currentUserSession.role === 'SUPER';
                                    const isCallCenter = currentUserSession.title === 'ÙƒÙˆÙ„ Ø³Ù†ØªØ±';
                                    const userBranch = currentUserSession.branch;

                                    // ØªØ¬Ù‡ÙŠØ² ÙƒÙˆØ¯ Ø§Ù„Ù€ HTML Ù„Ù„Ù‚ÙˆØ§Ø¦Ù…
                                    let branchesHtml = "";
                                    if (isSuper || isCallCenter) {
                                        branchesHtml = `<option value="ALL">-- Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ --</option>` +
                                                      branchesArray.map(b => `<option value="${b}">${b}</option>`).join('');
                                    } else {
                                        // Ù„Ùˆ Ù…ÙˆØ¸Ù Ø¹Ø§Ø¯ÙŠ ÙŠØ±Ù‰ ÙØ±Ø¹Ù‡ ÙÙ‚Ø·
                                        branchesHtml = `<option value="${userBranch}">${userBranch}</option>`;
                                    }

                                    // Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ù„Ù„ØªØ­Ø¯ÙŠØ«
                                    const selectors = [
                                        'global-branch-filter', 'reports-branch-filter',
                                        'log-filter-branch', 'radar-branch-filter-select',
                                        'f-branch-master-sel', 'adm-whatsapp-br-sel', 'reg-user-branch-sel-core'
                                    ];

                                    selectors.forEach(id => {
                                        const el = document.getElementById(id);
                                        if (el) {
                                            el.innerHTML = branchesHtml;
                                            if (!isSuper && !isCallCenter) {
                                                el.value = userBranch;
                                                el.disabled = true;
                                            }
                                        }
                                    });

                                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±ØªØ¨ Ø£ÙŠØ¶Ø§Ù‹
                                    const ranksObj = systemSettingsCache.custom_ranks || {};
                                    const ranksArray = Object.keys(ranksObj);
                                    const ranksHtml = ranksArray.length > 0
                                        ? ranksArray.map(r => `<option value="${r}">${r}</option>`).join('')
                                        : '<option value="">-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØªØ¨ --</option>';

                                    ['adm-rank-matrix-sel', 'reg-user-rank-sel-core'].forEach(id => {
                                        const el = document.getElementById(id);
                                        if (el) el.innerHTML = ranksHtml;
                                    });
                                }

                                // 2. Ø­Ø°Ù ÙØ±Ø¹ Ù…Ù† Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ²
                                async function deleteBranch(branchKey) {
                                    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ØŸ")) {
                                        await dbHub.ref('settings/branches/' + branchKey).remove();
                                        renderSystemToast("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹", "success");
                                    }
                                }

                                // 3. Ø¹Ø±Ø¶ Ø§Ù„ÙØ±ÙˆØ¹ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ² (ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ)
                                function renderAdminBranchScrollBox() {
                                    const b = document.getElementById('adm-branches-scroll-box');
                                    if(!b) return;
                                    b.innerHTML = "";

                                    // Ù†Ø¬Ù„Ø¨ Ø§Ù„ÙØ±ÙˆØ¹ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø°ÙŠ ÙŠÙ…ØªÙ„Ø¦ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ²
                                    const branchesObj = systemSettingsCache.branches || {};
                                    Object.keys(branchesObj).forEach((key) => {
                                        const branchName = branchesObj[key];
                                        b.innerHTML += `
                                            <div class="admin-row-item">
                                                <span>${branchName}</span>
                                                <i class="fas fa-trash" style="color:var(--danger-pulse);cursor:pointer;"
                                                onclick="deleteBranch('${key}')"></i>
                                            </div>`;
                                    });
                                }
                                async function renderBranchWhatsappList() {
                                    const br = document.getElementById('adm-whatsapp-br-sel').value;
                                    const box = document.getElementById('adm-whatsapp-scroll-box');

                                    if (!br || br === 'ALL') {
                                        box.innerHTML = "<small style='color:gray;'>Ø§Ø®ØªØ± ÙØ±Ø¹Ø§Ù‹ Ù…Ø­Ø¯Ø¯Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</small>";
                                        return;
                                    }

                                    box.innerHTML = "<small>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</small>";

                                    const snap = await dbHub.ref(`settings/whatsapp_phones/${br}`).once('value');
                                    const phonesData = snap.val();
                                    box.innerHTML = "";

                                    if (phonesData) {
                                        Object.keys(phonesData).forEach(key => {
                                            const phone = phonesData[key];
                                            box.innerHTML += `
                                                <div class="admin-row-item">
                                                    <span>${phone}</span>
                                                    <i class="fas fa-trash" style="color:var(--danger-pulse);cursor:pointer;"
                                                    onclick="deleteWhatsappFromFirebase('${br}', '${key}')"></i>
                                                </div>`;
                                        });
                                    } else {
                                        box.innerHTML = "<small style='color:gray;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹</small>";
                                    }
                                }

                                // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                                async function deleteWhatsappFromFirebase(br, key) {
                                    if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…ØŸ")) {
                                        await dbHub.ref(`settings/whatsapp_phones/${br}/${key}`).remove();
                                        renderBranchWhatsappList();
                                        renderSystemToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ù‚Ù…", "success");
                                    }
                                }
                                async function bindNewWhatsappToBranch() {
                                    const br = document.getElementById('adm-whatsapp-br-sel').value;
                                    const ph = document.getElementById('adm-whatsapp-phone-input').value.trim();

                                    if(!ph) { renderSystemToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", "danger"); return; }

                                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù… Ù„Ø¶Ù…Ø§Ù† Ø­ÙØ¸Ù‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
                                    let cleanPhone = ph.replace(/\D/g, '');
                                    if (cleanPhone.startsWith('01')) cleanPhone = '20' + cleanPhone.substring(1);

                                    try {
                                        // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase ØªØ­Øª Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹
                                        await dbHub.ref(`settings/whatsapp_phones/${br}`).push(cleanPhone);
                                        document.getElementById('adm-whatsapp-phone-input').value = "";
                                        renderSystemToast("ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø±Ù‚Ù… Ø¨Ø§Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­", "success");
                                        renderBranchWhatsappList(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                                    } catch (e) {
                                        renderSystemToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±", "danger");
                                    }
                                }
                                function deleteWhatsapp(br, index) {
                                    const phones = JSON.parse(localStorage.getItem('whatsapp_' + br) || '[]');
                                    phones.splice(index, 1);
                                    localStorage.setItem('whatsapp_' + br, JSON.stringify(phones));
                                    renderBranchWhatsappList();
                                }
                                function loadRankPermissionsMatrixHub() {
                                    const r = document.getElementById('adm-rank-matrix-sel').value;
                                    if(!r) { document.getElementById('adm-permissions-grid-hub').classList.add('hidden'); return; }
                                    document.getElementById('adm-permissions-grid-hub').classList.remove('hidden');
                                    const permissions = JSON.parse(localStorage.getItem('permissions') || '{}');
                                    const p = permissions[r] || {};
                                    ['view_all','create_ticket','reply_ticket','daily_edit','admin_access'].forEach(k => document.getElementById('perm-'+k.replace('_','-')).checked = p[k]||false);
                                }
                                function saveRankPermissionsSequence() {
                                    const r = document.getElementById('adm-rank-matrix-sel').value;
                                    const d = {}; ['view_all','create_ticket','reply_ticket','daily_edit','admin_access'].forEach(k => d[k] = document.getElementById('perm-'+k.replace('_','-')).checked);
                                    const permissions = JSON.parse(localStorage.getItem('permissions') || '{}');
                                    permissions[r] = d;
                                    localStorage.setItem('permissions', JSON.stringify(permissions));
                                    renderSystemToast("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«","success");
                                }
                                // 1. ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ²
                                async function registerNewUserToSystemSequence() {
                                    const id = document.getElementById('reg-user-id-core').value.trim();
                                    const d = {
                                        name: document.getElementById('reg-user-fullname-core').value,
                                        title: document.getElementById('reg-user-rank-sel-core').value,
                                        branch: document.getElementById('reg-user-branch-sel-core').value,
                                        pass: document.getElementById('reg-user-pass-core').value
                                    };

                                    if(id && d.name && d.pass) {
                                        // Ø§Ù„Ø­ÙØ¸ ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ²
                                        await dbHub.ref('users/' + id).set(d);

                                        // Ù…Ø³Ø­ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                                        ['reg-user-id-core','reg-user-fullname-core','reg-user-pass-core'].forEach(i => document.getElementById(i).value = '');
                                        renderSystemToast("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­", "success");
                                    } else {
                                        renderSystemToast("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "danger");
                                    }
                                }

                                // 2. Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ù† Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ²
                                async function renderAdminUsersScrollBox() {
                                    const b = document.getElementById('adm-users-scroll-box');
                                    if(!b) return;
                                    b.innerHTML = "";

                                    const snap = await dbHub.ref('users').once('value');
                                    const users = snap.val() || {};

                                    Object.keys(users).forEach(uid => {
                                        const u = users[uid];
                                        b.innerHTML += `
                                            <div class="admin-row-item">
                                                <div>
                                                    <b style="color:var(--gold-master)">${u.name}</b>
                                                    <small>(${u.title})</small>
                                                </div>
                                                <div style="display:flex; gap:15px;">
                                                    <i class="fas fa-user-edit" style="color:var(--success-glow); cursor:pointer;" onclick="openEditUserModal('${uid}')"></i>
                                                    <i class="fas fa-trash" style="color:var(--danger-pulse); cursor:pointer;" onclick="deleteUserEntirely('${uid}', '${u.name}')"></i>
                                                </div>
                                            </div>`;
                                    });
                                }

                                async function openEditUserModal(uid) {
                                    // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† localStorage
                                    const users = JSON.parse(localStorage.getItem('users') || '{}');
                                    const u = users[uid];
                                    if(!u) return;

                                    // 2. ØªØ­Ø¶ÙŠØ± Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±ØªØ¨ ÙˆØ§Ù„ÙØ±ÙˆØ¹ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                                    const ranksOptions = Object.keys(systemSettingsCache.custom_ranks || {}).map(r => `<option value="${r}" ${u.title === r ? 'selected' : ''}>${r}</option>`).join('');
                                    const branchesOptions = branchListCache.map(b => `<option value="${b}" ${u.branch === b ? 'selected' : ''}>${b}</option>`).join('');

                                    // 3. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SweetAlert2
                                    const { value: formValues } = await Swal.fire({
                                        title: `<span style="color:var(--gold-master)">ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨: ${u.name}</span>`,
                                        background: '#0d1117',
                                        color: '#f0f6fc',
                                        html: `
                                            <div style="text-align:right; direction:rtl;">
                                                <label style="display:block; margin-bottom:5px;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                                                <input id="swal-name" class="swal2-input" value="${u.name}" style="margin:0 0 15px 0; width:100%;">
                                                
                                                <label style="display:block; margin-bottom:5px;">Ø§Ù„Ø±ØªØ¨Ø© / Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</label>
                                                <select id="swal-rank" class="swal2-input" style="margin:0 0 15px 0; width:100%;">
                                                    ${ranksOptions}
                                                </select>

                                                <label style="display:block; margin-bottom:5px;">Ø§Ù„ÙØ±Ø¹:</label>
                                                <select id="swal-branch" class="swal2-input" style="margin:0 0 15px 0; width:100%;">
                                                    <option value="ALL" ${u.branch === 'ALL' ? 'selected' : ''}>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</option>
                                                    ${branchesOptions}
                                                </select>

                                                <label style="display:block; margin-bottom:5px;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
                                                <input id="swal-pass" type="text" class="swal2-input" value="${u.pass}" style="margin:0 0 15px 0; width:100%;">
                                                
                                                <p style="font-size:0.8rem; color:var(--danger-pulse);">* Ù…Ù„Ø­ÙˆØ¸Ø©: ØªØºÙŠÙŠØ± Ø§Ù„Ù€ ID ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø­ÙØ§Ø¸Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª.</p>
                                            </div>
                                        `,
                                        focusConfirm: false,
                                        showCancelButton: true,
                                        confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª',
                                        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                                        confirmButtonColor: 'var(--gold-master)',
                                        preConfirm: () => {
                                            return {
                                                name: document.getElementById('swal-name').value,
                                                title: document.getElementById('swal-rank').value,
                                                branch: document.getElementById('swal-branch').value,
                                                pass: document.getElementById('swal-pass').value
                                            }
                                        }
                                    });

                                    // 4. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ localStorage
                                    if (formValues) {
                                        if(!formValues.name || !formValues.pass) {
                                            renderSystemToast("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†!", "danger");
                                            return;
                                        }

                                        users[uid] = formValues;
                                        localStorage.setItem('users', JSON.stringify(users));
                                        
                                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
                                        renderAdminUsersScrollBox();
                                        renderSystemToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­", "success");
                                    }
                                }
                                async function registerNewRankTitleCore() {
                                    const rankName = document.getElementById('adm-rank-name-input').value.trim();
                                    if (!rankName) {
                                        renderSystemToast("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø±ØªØ¨Ø© Ø£ÙˆÙ„Ø§Ù‹", "danger");
                                        return;
                                    }

                                    try {
                                        // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± - Ø§Ù„Ù€ Listener Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ Ù‡ÙŠØ­Ø¯Ø« Ø§Ù„Ø´Ø§Ø´Ø© Ù„ÙˆØ­Ø¯Ù‡ ÙÙˆØ±Ø§Ù‹
                                        await dbHub.ref('settings/custom_ranks/' + rankName).set(true);
                                        document.getElementById('adm-rank-name-input').value = "";
                                        renderSystemToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­", "success");
                                    } catch (e) {
                                        renderSystemToast("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±", "danger");
                                    }
                                }
                            
                            function runPermissionShieldCheck() {
                                const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};

                                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§
                                const tabAdmin = document.getElementById('tab-admin');
                                const floatingBtn = document.getElementById('floating-plus-btn');
                                const licenseSection = document.getElementById('license-admin-section');

                                if(tabAdmin && (p.admin_access || currentUserSession.role === 'SUPER')) {
                                    tabAdmin.classList.remove('hidden');
                                }

                                if(floatingBtn) {
                                    floatingBtn.className = (p.create_ticket || currentUserSession.role === 'SUPER' || currentUserSession.title === 'ÙƒÙˆÙ„ Ø³Ù†ØªØ±') ? 'floating-action-master' : 'hidden';
                                }

                                if(licenseSection && currentUserSession.role === 'SUPER') {
                                    licenseSection.style.display = 'block';
                                }
                            }

                            // Helpers
                            function openSidebarControl() { document.getElementById('sidebar-complaint-arc-hub').classList.add('open'); document.getElementById('master-dimmer').style.display='block'; }
                            function closeSidebarControl() { document.getElementById('sidebar-complaint-arc-hub').classList.remove('open'); document.getElementById('master-dimmer').style.display='none'; }
                            function toggleSidebar() { const n = document.getElementById('system-side-nav'), d = document.getElementById('master-dimmer'); n.classList.toggle('open'); d.style.display = n.classList.contains('open') ? 'block' : 'none'; }
                            function closeAllMenus() { document.getElementById('system-side-nav').classList.remove('open'); closeSidebarControl(); }
                            function switchToAppModule(m) {
                                // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                                document.querySelectorAll('.nav-link-vip').forEach(b => b.classList.remove('active'));
                                document.getElementById('tab-'+m).classList.add('active');
                                ['live','daily','archive','reports','admin'].forEach(id => {
                                    if(document.getElementById('module-view-'+id))
                                        document.getElementById('module-view-'+id).classList.add('hidden');
                                });
                                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                                const targetModule = document.getElementById('module-view-'+m);
                                if(targetModule) targetModule.classList.remove('hidden');
                                // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                                if(m === 'reports') {
                                    // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
                                    setTimeout(() => {
                                        executeAdvancedAnalyticsSequence();
                                    }, 500);
                                }
                            }
                            function renderSystemToast(m, t) {
                                const b = document.getElementById('system-toast-container'), toast = document.createElement('div');
                                toast.className = 'toast-msg-vip'; if(t==='danger') toast.style.background='#ef4444';
                                toast.innerHTML = `<i class="fas ${t==='danger'?'fa-triangle-exclamation':'fa-circle-check'}"></i> ${m}`;
                                b.appendChild(toast); setTimeout(() => toast.remove(), 5000);
                            }

                            function toggleTicketDetails(el) {
                                el.classList.toggle('expanded');
                            }

                            function populateDetailedComplaintsTable(ops) {
                                const tableBody = document.getElementById('complaints-table-body');
                                tableBody.innerHTML = '';
                                const userBranch = currentUserSession.branch;
                                const isSuper = currentUserSession.role === 'SUPER' || userBranch === 'ALL';

                                const categories = ["ØªØ£Ø®ÙŠØ±", "Ø³ÙˆØ¡ Ø®Ø¯Ù…Ø©", "Ù†Ø§Ù‚Øµ", "Ø³ÙˆØ¡ ØªØ¹Ø¨Ø¦Ø©", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ", "Ø¬ÙˆØ¯Ø©", "Ø¬Ø³Ù… ØºØ±ÙŠØ¨", "Ø³ÙˆØ¡ Ø³Ù„ÙˆÙƒ", "Ù…Ù†Ø¯ÙˆØ¨", "Ø·Ù„Ø¨ Ø¨Ø§Ø±Ø¯", "Ø±Ø³ÙŠØ¨ÙŠ", "ØªØ£Ø®ÙŠØ± Ø´ÙƒÙˆÙ‰", "ØªÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„ÙØ±Ø¹", "Ø³ÙˆØ´ÙŠØ§Ù„"];
                                const serviceTypes = ["HD", "Din In", "PK", "TA"];

                                let colTotals = {};
                                categories.forEach(c => colTotals[c] = 0);
                                serviceTypes.forEach(s => colTotals[s] = 0);
                                let absoluteGrandTotal = 0;

                                branchListCache.forEach(branch => {
                                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†ØŒ Ø§Ø¹Ø±Ø¶ ÙØ±Ø¹Ù‡ ÙÙ‚Ø·
                                    if (!isSuper && branch !== userBranch) return;

                                    const branchOps = ops.filter(o => o.branch === branch);
                                    if (branchOps.length === 0) return;

                                    let branchTotal = branchOps.length;
                                    let rowHtml = `<td style="padding:12px; border:1px solid #333; font-weight:bold; background:#010409; position: sticky; right: 0; z-index: 5; color: var(--gold-master);">${branch}</td>`;

                                    categories.forEach(cat => {
                                        const count = branchOps.filter(o => o.type === cat).length;
                                        rowHtml += `<td style="border:1px solid #333; background:#010409;">${count || 0}</td>`;
                                        colTotals[cat] += count;
                                    });

                                    serviceTypes.forEach(srv => {
                                        const count = branchOps.filter(o => o.service_type === srv).length;
                                        rowHtml += `<td style="border:1px solid #333; background:#0d1117;">${count || 0}</td>`;
                                        colTotals[srv] += count;
                                    });

                                    rowHtml += `<td style="border:1px solid #333; position: sticky; left: 0; background:#f59e0b; color:#000; font-weight:bold; z-index: 5; box-shadow: -2px 0 5px rgba(0,0,0,0.5);">${branchTotal}</td>`;
                                    tableBody.innerHTML += `<tr>${rowHtml}</tr>`;
                                    absoluteGrandTotal += branchTotal;
                                });

                                if (absoluteGrandTotal === 0) {
                                    tableBody.innerHTML = `<tr><td colspan="${2 + categories.length + serviceTypes.length}" style="text-align:center; padding:50px; color:var(--text-muted-core);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</td></tr>`;
                                    return;
                                }

                                let footerHtml = `<tr style="font-weight:900; position: sticky; bottom: 0; z-index: 110; background:#1d4ed8; color:white;"><td style="position: sticky; right: 0; background:#1d4ed8; z-index: 111; border:1px solid #333;">Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰ Ø§Ù„Ø¹Ø§Ù…</td>`;
                                categories.forEach(cat => footerHtml += `<td style="border:1px solid #333;">${colTotals[cat]}</td>`);
                                serviceTypes.forEach(srv => footerHtml += `<td style="border:1px solid #333; background:#0a2e91;">${colTotals[srv]}</td>`);
                                footerHtml += `<td style="position: sticky; left: 0; background:#f59e0b; color:black; z-index: 111; border:1px solid #333;">${absoluteGrandTotal}</td></tr>`;
                                tableBody.innerHTML += footerHtml;

                                // Ù„Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠ filterTableByBranch Ù‡Ù†Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… SUPER
                                if (!isSuper) {
                                    filterTableByBranch();
                                }
                            }

                            function populateEfficiencyTable(ops, allDays, from, to) {
                                const tableBody = document.getElementById('efficiency-table-body');
                                tableBody.innerHTML = '';

                                let grandTotalOps = 0;
                                let grandTotalComplaints = 0;

                                branchListCache.forEach(branch => {
                                    let branchOrders = 0;
                                    Object.keys(allDays).forEach(day => {
                                        if (day >= from && day <= to) branchOrders += parseInt(allDays[day][branch] || 0);
                                    });

                                    const branchComplaints = ops.filter(o => o.branch === branch).length;
                                    if (branchOrders === 0 && branchComplaints === 0) return;

                                    const ratio = branchOrders > 0 ? ((branchComplaints / branchOrders) * 100).toFixed(2) : "0.00";

                                    tableBody.innerHTML += `
                                        <tr style="border-bottom:1px solid #333;">
                                            <td style="padding:10px; text-align:right; font-weight:bold;">${branch}</td>
                                            <td>${branchOrders.toLocaleString()}</td>
                                            <td>${branchComplaints}</td>
                                            <td style="color:var(--gold-master); font-weight:bold;">${ratio}%</td>
                                        </tr>
                                    `;

                                    grandTotalOps += branchOrders;
                                    grandTotalComplaints += branchComplaints;
                                });

                                // Ø³Ø·Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                                const totalRatio = grandTotalOps > 0 ? ((grandTotalComplaints / grandTotalOps) * 100).toFixed(2) : "0.00";
                                tableBody.innerHTML += `
                                    <tr style="background:#111; border-top:2px solid var(--gold-master); font-weight:bold;">
                                        <td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                                        <td>${grandTotalOps.toLocaleString()}</td>
                                        <td>${grandTotalComplaints}</td>
                                        <td style="color:var(--gold-bright);">${totalRatio}%</td>
                                    </tr>
                                `;
                            }

                            function refreshAllModulesData() {
                                const selectedBranch = document.getElementById('global-branch-filter').value;
                                document.getElementById('branch-quick-stat').innerText = selectedBranch === 'ALL' ? "ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©" : "ÙØ±Ø¹: " + selectedBranch;

                                // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ ÙÙˆØ±Ø§Ù‹
                                renderLiveBroadcastMatrix();
                                runArchiveRefreshSequence();
                                loadDailySnapshotData();
                                if(!document.getElementById('module-view-reports').classList.contains('hidden')) {
                                    executeAdvancedAnalyticsSequence();
                                }
                            }

                            // --- Ù…Ø­Ø±Ùƒ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„ØªØ±Ø®ÙŠØµ ---
                            function initSystemGuard() {
                                const lockOverlay = document.getElementById('system-lock-overlay');
                                const lockTitle = document.getElementById('lock-title');
                                const lockMsg = document.getElementById('lock-msg');

                                // Ø±Ø¨Ø· Ù…Ø¹ Ø¹Ù‚Ø¯Ø© config ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ²
                                dbHub.ref('config').on('value', snap => {
                                    const config = snap.val() || {};
                                    const now = Date.now();
                                    const exp = config.expiryDate || 0;
                                    const graceMs = (config.graceDays || 0) * 24 * 60 * 60 * 1000;
                                    const hardLock = exp + graceMs;

                                    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø©
                                    document.getElementById('pay-phone').innerText = config.payPhone || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
                                    document.getElementById('pay-acc').innerText = config.accNumber || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
                                    document.getElementById('pay-name').innerText = config.accName || "ØºÙŠØ± Ù…ØªÙˆÙØ±";

                                    let isLocked = false;

                                    // 1. Ø§Ù„Ù‚ÙÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
                                    if (config.manualLocked) {
                                        isLocked = true;
                                        lockTitle.innerText = "LOCKED";
                                        lockMsg.innerText = "ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.";
                                    }
                                    // 2. Ø§Ù„Ù‚ÙÙ„ Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ + Ø§Ù„Ø³Ù…Ø§Ø­
                                    else if (now >= hardLock) {
                                        isLocked = true;
                                        lockTitle.innerText = "EXPIRED";
                                        lockMsg.innerText = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ ÙØªØ±Ø© Ø§Ù„Ø³Ù…Ø§Ø­.";
                                    }

                                    // ØªÙ†ÙÙŠØ° Ø§Ù„Ù‚ÙÙ„ Ø£Ùˆ Ø§Ù„ÙØªØ­
                                    if (isLocked) {
                                        lockOverlay.style.display = 'flex';
                                        document.body.style.overflow = 'hidden'; // Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø®Ù„Ù Ø§Ù„Ù‚ÙÙ„
                                    } else {
                                        lockOverlay.style.display = 'none';
                                        document.body.style.overflow = 'auto';

                                        // Ø¥Ø¯Ø§Ø±Ø© Ø£Ø´Ø±Ø·Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡)
                                        manageExpiryWarnings(now, exp, hardLock);
                                    }
                                });
                            }

                            // ÙˆØ¸ÙŠÙØ© Ø¥Ø¸Ù‡Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                            function manageExpiryWarnings(now, exp, hardLock) {
                                const alertThreshold = 24 * 60 * 60 * 1000; // 24 Ø³Ø§Ø¹Ø©

                                if (now < exp && (exp - now) <= alertThreshold) {
                                    // ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙØ± (Ù‚Ø±Ø¨ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡)
                                    renderSystemBar('warning', exp - now);
                                } else if (now >= exp && now < hardLock) {
                                    // ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± (ÙØªØ±Ø© Ø³Ù…Ø§Ø­)
                                    renderSystemBar('danger', hardLock - now);
                                } else {
                                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª ÙƒØ§ÙÙŠØ§Ù‹
                                    const existingBar = document.getElementById('expiry-warning-bar');
                                    if (existingBar) existingBar.remove();
                                }
                            }

                            function renderSystemBar(type, ms) {
                                let bar = document.getElementById('expiry-warning-bar');
                                if (!bar) {
                                    bar = document.createElement('div');
                                    bar.id = 'expiry-warning-bar';
                                    document.body.prepend(bar);
                                }

                                const d = Math.floor(ms / (1000 * 60 * 60 * 24));
                                const h = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                const m = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
                                const s = Math.floor((ms % (1000 * 60)) / 1000);
                                const timeStr = `${d}:${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

                                if (type === 'warning') {
                                    bar.style = "background:#fbbf24; color:#000; text-align:center; padding:6px; font-weight:800; font-size:13px; position:sticky; top:0; z-index:9999; direction:rtl;";
                                    bar.innerHTML = `âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø®Ù„Ø§Ù„ (${timeStr}). ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙˆÙ‚Ù.`;
                                } else {
                                    bar.style = "background:#ef4444; color:#fff; text-align:center; padding:6px; font-weight:800; font-size:13px; position:sticky; top:0; z-index:9999; direction:rtl;";
                                    bar.innerHTML = `ğŸš¨ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ! Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨ÙØªØ±Ø© Ø³Ù…Ø§Ø­ØŒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: (${timeStr}).`;
                                }
                            }

                            let licenseInterval; // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø«Ø§Ù†ÙŠØ© Ø¨Ø«Ø§Ù†ÙŠØ©

                            function startLicenseProtection() {
                                const lockScreen = document.getElementById('license-lock-screen');
                                let banner = document.getElementById('license-banner');
                                if (!banner) {
                                    banner = document.createElement('div');
                                    banner.id = 'license-banner';
                                    document.body.prepend(banner);
                                }

                                dbHub.ref('config').on('value', (snapshot) => {
                                    const config = snapshot.val() || {};
                                    if (licenseInterval) clearInterval(licenseInterval);

                                    licenseInterval = setInterval(() => {
                                        const now = Date.now();
                                        const expiry = config.expiryDate || 0;
                                        const graceMs = (config.graceDays || 0) * 24 * 60 * 60 * 1000;
                                        const finalDeadline = expiry + graceMs;

                                        // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ²
                                        document.getElementById('p-phone').innerText = config.payPhone || "0100060338";
                                        document.getElementById('p-acc').innerText = config.accNumber || "222";
                                        document.getElementById('p-name').innerText = config.accName || "Ø£/ ØªØ§Ù…Ø±";

                                        if (config.manualLocked || (now > finalDeadline && expiry !== 0)) {
                                            lockScreen.style.display = 'flex';
                                            banner.style.display = 'none';
                                        } else {
                                            lockScreen.style.display = 'none';
                                            // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¨Ù†Ø± (Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¹Ù„ÙˆÙŠ)
                                            manageExpiryWarnings(now, expiry, finalDeadline);
                                        }
                                    }, 1000);
                                });
                            }

                            // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ù„ØªÙ†Ø³ÙŠÙ‚ (Ø£ÙŠØ§Ù…:Ø³Ø§Ø¹Ø§Øª:Ø¯Ù‚Ø§Ø¦Ù‚:Ø«ÙˆØ§Ù†ÙŠ)
                            function formatTime(ms) {
                                const days = Math.floor(ms / (24 * 60 * 60 * 1000));
                                const hours = Math.floor((ms % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
                                const mins = Math.floor((ms % (60 * 60 * 1000)) / (60 * 1000));
                                const secs = Math.floor((ms % (60 * 1000)) / 1000);

                                return `${days}:${hours.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
                            }

                            // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                            // Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø¯Ø§Ø®Ù„ window.onload Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ
                            const oldOnloadFunc = window.onload;
                            window.onload = () => {
                                if (oldOnloadFunc) oldOnloadFunc(); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                                startLicenseProtection(); // ØªØ´ØºÙŠÙ„ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØ±Ø®ÙŠØµ
                            };

                            // Ø¯Ø§Ù„Ø© ØªØ¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø£Ø±Ø´ÙØ© Ø¹Ù†Ø¯ Ø¶ØºØ· Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„Ù‰ "ØªÙ…Ø§Ù…"
                            function startArchiveProcess() {
                                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                                if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ù†Ù‚Ù„Ù‡ Ù„Ù„Ø£Ø±Ø´ÙŠÙ Ø®Ù„Ø§Ù„ 5 Ø¯Ù‚Ø§Ø¦Ù‚.")) {

                                    const finishTime = Date.now() + (5 * 60 * 1000); // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ + 5 Ø¯Ù‚Ø§Ø¦Ù‚

                                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                    dbHub.ref('config').update({
                                        archiveTime: finishTime,
                                        isArchived: false,
                                        // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§ Ù„ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙˆØ±Ø§Ù‹
                                        status: "waiting_archive"
                                    }).then(() => {
                                        // ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø²Ø± ÙÙˆØ±Ø§Ù‹ Ù„ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø£Ù† Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ø¯Ø£Øª
                                        const btn = document.getElementById('finish-btn');
                                        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ù‚Ù„ Ù„Ù„Ø£Ø±Ø´ÙŠÙ...";
                                        btn.style.background = "#f97316"; // ØªØ­ÙˆÙŠÙ„ Ù„ÙˆÙ†Ù‡ Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
                                        btn.disabled = true; // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø±
                                    });
                                }
                            }

                            // ÙƒÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø© (Ù„ÙŠØ®ØªÙÙŠ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ØªÙ…Ø§Ù…Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª)
                            dbHub.ref('config').on('value', snap => {
                                const data = snap.val();
                                if (data && data.isArchived) {
                                    // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø£Ø±Ø´ÙØ©ØŒ Ù‚Ù… Ø¨Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„ØµÙØ­Ø© Ø£Ø®Ø±Ù‰
                                    document.body.innerHTML = "<div style='color:white; text-align:center; margin-top:100px;'><h2>ğŸ“¦ ØªÙ… Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø£Ø±Ø´ÙŠÙ</h2></div>";
                                }
                            });

                            // 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (URL)
                            const urlParams = new URLSearchParams(window.location.search);
                            const currentBranch = urlParams.get('branch');
                            const loggedInBranch = currentBranch || "Ø±ÙˆÙƒØ³ÙŠ";

                            // 2. ÙˆØ¸ÙŠÙØ© Ø§Ù„ÙÙ„ØªØ±Ø© (ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³)
                            function filterTableByBranch() {
                                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ Ø§Ø¹ØªØ¨Ø±Ù‡ "Ø£Ø¯Ù…Ù†" ÙˆØ§Ø¹Ø±Ø¶ ÙƒÙ„ Ø´ÙŠØ¡
                                if (!currentBranch) return;

                                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø£Ø³)
                                const rows = document.querySelectorAll("table tbody tr");

                                rows.forEach(row => {
                                    // Ù†Ø­Ø¯Ø¯ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù… (ØºØ§Ù„Ø¨Ø§Ù‹ Ù‡ÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„)
                                    const branchCell = row.querySelector("td:first-child");

                                    if (branchCell) {
                                        const branchName = branchCell.innerText.trim();

                                        // Ø¥Ø¸Ù‡Ø§Ø± ØµÙ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡ + ØµÙ "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" ÙÙ‚Ø·
                                        if (branchName === currentBranch || branchName === "Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰" || branchName === "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ") {
                                            row.style.display = ""; // Ø¥Ø¸Ù‡Ø§Ø±
                                        } else {
                                            row.style.display = "none"; // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙØ±ÙˆØ¹
                                        }
                                    }
                                });

                                // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ù„ÙŠÙˆØ¶Ø­ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹
                                document.querySelector("h2").innerText = "ØªÙ‚Ø±ÙŠØ± ÙØ±Ø¹: " + currentBranch;
                            }

                            // Admin License Functions
                            async function adminFullActivate() {
                                const d = parseInt(document.getElementById('admin-in-days').value) || 0;
                                const h = parseInt(document.getElementById('admin-in-hours').value) || 0;
                                const grace = parseInt(document.getElementById('admin-in-grace').value) || 0;

                                // ØªØµÙÙŠØ± ÙˆØ¨Ø¯Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¢Ù†
                                const msToAdd = (d * 24 * 60 * 60 * 1000) + (h * 60 * 60 * 1000);
                                const newExpiry = Date.now() + msToAdd;

                                dbHub.ref('config').set({
                                    expiryDate: newExpiry, // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                                    graceDays: grace,      // ÙØªØ±Ø© Ø§Ù„Ø³Ù…Ø§Ø­
                                    payPhone: document.getElementById('admin-in-phone').value,
                                    accNumber: document.getElementById('admin-in-acc').value,
                                    accName: document.getElementById('admin-in-name').value,
                                    manualLocked: false
                                }).then(() => {
                                    alert("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­!\nØ§Ù„Ø£Ø³Ø§Ø³ÙŠ: " + d + " ÙŠÙˆÙ…\nØ§Ù„Ø³Ù…Ø§Ø­: " + grace + " ÙŠÙˆÙ…");
                                    document.getElementById('admin-in-days').value = 0;
                                    document.getElementById('admin-in-hours').value = 0;
                                });
                            }

                            function adminToggleLock() { dbHub.ref('config/manualLocked').set(!currentConfig.manualLocked); }
                    </script>
                </body>
            </html>         
